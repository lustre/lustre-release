<?xml version='1.0' encoding='UTF-8'?>
<chapter xmlns="http://docbook.org/ns/docbook"
 xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en-US"
 xml:id="managinglnet">
  <title xml:id="managinglnet.title">Managing Lustre Networking (LNet)</title>
  <para>This chapter describes some tools for managing Lustre networking (LNet) and includes the
    following sections:</para>
  <itemizedlist>
    <listitem>
      <para><xref linkend="dbdoclet.50438203_51732"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438203_48703"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438203_82542"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438203_78227"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="managinglnet.configuringroutes"/></para>
    </listitem>
  </itemizedlist>
  <section xml:id="dbdoclet.50438203_51732">
      <title><indexterm><primary>LNet</primary><secondary>management</secondary></indexterm>
          Updating the Health Status of a Peer or Router</title>
    <para>There are two mechanisms to update the health status of a peer or a router:</para>
    <itemizedlist>
      <listitem>
        <para>LNet can actively check health status of all routers and mark them as dead or alive automatically. By default, this is off. To enable it set <literal>auto_down</literal> and if desired <literal>check_routers_before_use</literal>. This initial check may cause a pause equal to <literal>router_ping_timeout</literal> at system startup, if there are dead routers in the system.</para>
      </listitem>
      <listitem>
        <para>When there is a communication error, all LNDs notify LNet that the peer (not necessarily a router) is down. This mechanism is always on, and there is no parameter to turn it off. However, if you set the LNet module parameter <literal>auto_down</literal> to <literal>0</literal>, LNet ignores all such peer-down notifications.</para>
      </listitem>
    </itemizedlist>
    <para>Several key differences in both mechanisms:</para>
    <itemizedlist>
      <listitem>
        <para>The router pinger only checks routers for their health, while LNDs notices all dead peers, regardless of whether they are a router or not.</para>
      </listitem>
      <listitem>
        <para>The router pinger actively checks the router health by sending pings, but LNDs only notice a dead peer when there is network traffic going on.</para>
      </listitem>
      <listitem>
        <para>The router pinger can bring a router from alive to dead or vice versa, but LNDs can only bring a peer down.</para>
      </listitem>
    </itemizedlist>
  </section>
  <section xml:id="dbdoclet.50438203_48703">
      <title><indexterm><primary>LNet</primary><secondary>starting/stopping</secondary></indexterm>Starting and Stopping LNet</title>
    <para>The Lustre software automatically starts and stops LNet, but it can also be manually
      started in a standalone manner. This is particularly useful to verify that your networking
      setup is working correctly before you attempt to start the Lustre file system.</para>
    <section remap="h3">
      <title>Starting LNet</title>
      <para>To start LNet, run:</para>
      <screen>$ modprobe lnet
$ lctl network up</screen>
      <para>To see the list of local NIDs, run:</para>
      <screen>$ lctl list_nids</screen>
      <para>This command tells you the network(s) configured to work with the Lustre file
        system.</para>
      <para>If the networks are not correctly setup, see the <literal>modules.conf</literal> &quot;<literal>networks=</literal>&quot; line and make sure the network layer modules are correctly installed and configured.</para>
      <para>To get the best remote NID, run:</para>
      <screen>$ lctl which_nid <replaceable>NIDs</replaceable></screen>
      <para>where <literal><replaceable>NIDs</replaceable></literal> is the list of available NIDs.</para>
      <para>This command takes the &quot;best&quot; NID from a list of the NIDs of a remote host. The &quot;best&quot; NID is the one that the local node uses when trying to communicate with the remote node.</para>
      <section remap="h4">
        <title>Starting Clients</title>
        <para>To start a TCP client, run:</para>
        <screen>mount -t lustre mdsnode:/mdsA/client /mnt/lustre/</screen>
        <para>To start an Elan client, run:</para>
        <screen>mount -t lustre 2@elan0:/mdsA/client /mnt/lustre</screen>
      </section>
    </section>
    <section remap="h3">
      <title>Stopping LNet</title>
      <para>Before the LNet modules can be removed, LNet references must be removed. In general,
        these references are removed automatically when the Lustre file system is shut down, but for
        standalone routers, an explicit step is needed to stop LNet. Run:</para>
      <screen>lctl network unconfigure</screen>
      <note>
        <para>Attempting to remove Lustre modules prior to stopping the network may result in a
          crash or an LNet hang. If this occurs, the node must be rebooted (in most cases). Make
          sure that the Lustre network and Lustre file system are stopped prior to unloading the
          modules. Be extremely careful using <literal>rmmod -f</literal>.</para>
      </note>
      <para>To unconfigure the LNet network, run:</para>
      <screen>modprobe -r <replaceable>lnd_and_lnet_modules</replaceable></screen>
      <note>
        <para>
To remove all Lustre modules, run:</para>
        <para><literal>$ lustre_rmmod</literal></para>
      </note>
    </section>
  </section>
  <section xml:id="dbdoclet.50438203_82542">
    <title><indexterm><primary>LNet</primary><secondary>hardware multi-rail
    configuration</secondary></indexterm>Hardware Based Multi-Rail
    Configurations with LNet</title>
    <para>To aggregate bandwidth across both rails of a dual-rail IB cluster
        (o2iblnd) <footnote>
        <para>Hardware multi-rail configurations are only supported by o2iblnd;
        other IB LNDs do not support multiple interfaces.</para>
      </footnote> using LNet, consider these points:</para>
    <itemizedlist>
      <listitem>
        <para>LNet can work with multiple rails, however, it does not load
        balance across them. The actual rail used for any communication is
        determined by the peer NID.</para>
      </listitem>
      <listitem>
        <para>Hardware multi-rail LNet configurations do not provide an
        additional level of network fault tolerance. The configurations
        described below are for bandwidth aggregation only.</para>
      </listitem>
      <listitem>
        <para>A Lustre node always uses the same local NID to communicate with a
        given peer NID. The criteria used to determine the local NID are:</para>
        <itemizedlist>
	      <listitem>
	        <para condition='l25'>Lowest route priority number (lower number,
            higher priority).</para>
	      </listitem>
          <listitem>
            <para>Fewest hops (to minimize routing), and</para>
          </listitem>
          <listitem>
            <para>Appears first in the &quot;<literal>networks</literal>&quot;
            or &quot;<literal>ip2nets</literal>&quot; LNet configuration strings
            </para>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>
  </section>
  <section xml:id="dbdoclet.50438203_78227">
    <title><indexterm>
        <primary>LNet</primary>
        <secondary>InfiniBand load balancing</secondary>
      </indexterm>Load Balancing with an InfiniBand<superscript>*</superscript> Network</title>
    <para>A Lustre file system contains OSSs with two InfiniBand HCAs. Lustre clients have only one
      InfiniBand HCA using OFED-based Infiniband &apos;&apos;o2ib&apos;&apos; drivers. Load
      balancing between the HCAs on the OSS is accomplished through LNet.</para>
    <section remap="h3">
      <title><indexterm><primary>LNet</primary><secondary>lustre.conf</secondary></indexterm>Setting Up <literal>lustre.conf</literal> for Load Balancing</title>
      <para>To configure LNet for load balancing on clients and servers:</para>
      <orderedlist>
        <listitem>
          <para>Set the <literal>lustre.conf</literal> options.</para>
          <para>Depending on your configuration, set <literal>lustre.conf</literal> options as follows:</para>
          <itemizedlist>
            <listitem>
              <para>Dual HCA OSS server</para>
            </listitem>
          </itemizedlist>
          <screen>options lnet networks="o2ib0(ib0),o2ib1(ib1)"</screen>
          <itemizedlist>
            <listitem>
              <para>Client with the odd IP address</para>
            </listitem>
          </itemizedlist>
          <screen>options lnet ip2nets="o2ib0(ib0) 192.168.10.[103-253/2]"</screen>
          <itemizedlist>
            <listitem>
              <para>Client with the even IP address</para>
            </listitem>
          </itemizedlist>
          <screen>options lnet ip2nets="o2ib1(ib0) 192.168.10.[102-254/2]"</screen>
        </listitem>
        <listitem>
          <para>Run the modprobe lnet command and create a combined MGS/MDT file system.</para>
          <para>The following commands create an MGS/MDT or OST file system and mount the targets on the servers.</para>
          <screen>modprobe lnet
# mkfs.lustre --fsname lustre --mgs --mdt <replaceable>/dev/mdt_device</replaceable>
# mkdir -p <replaceable>/mount_point</replaceable>
# mount -t lustre /dev/<replaceable>mdt_device</replaceable> <replaceable>/mount_point</replaceable></screen>
          <para>For example:</para>
          <screen>modprobe lnet
mds# mkfs.lustre --fsname lustre --mdt --mgs /dev/sda
mds# mkdir -p /mnt/test/mdt
mds# mount -t lustre /dev/sda /mnt/test/mdt   
mds# mount -t lustre mgs@o2ib0:/lustre /mnt/mdt
oss# mkfs.lustre --fsname lustre --mgsnode=mds@o2ib0 --ost --index=0 /dev/sda
oss# mkdir -p /mnt/test/mdt
oss# mount -t lustre /dev/sda /mnt/test/ost   
oss# mount -t lustre mgs@o2ib0:/lustre /mnt/ost0</screen>
        </listitem>
        <listitem>
          <para>Mount the clients.</para>
          <screen>client# mount -t lustre <replaceable>mgs_node</replaceable>:/<replaceable>fsname</replaceable> <replaceable>/mount_point</replaceable></screen>
          <para>This example shows an IB client being mounted.</para>
          <screen>client# mount -t lustre
192.168.10.101@o2ib0,192.168.10.102@o2ib1:/mds/client /mnt/lustre</screen>
        </listitem>
      </orderedlist>
      <para>As an example, consider a two-rail IB cluster running the OFED stack with these IPoIB
        address assignments.</para>
      <screen>             ib0                             ib1
Servers            192.168.0.*                     192.168.1.*
Clients            192.168.[2-127].*               192.168.[128-253].*</screen>
      <para>You could create these configurations:</para>
      <itemizedlist>
        <listitem>
          <para>A cluster with more clients than servers. The fact that an individual client cannot get two rails of bandwidth is unimportant because the servers are typically the actual bottleneck.</para>
        </listitem>
      </itemizedlist>
      <screen>ip2nets=&quot;o2ib0(ib0),    o2ib1(ib1)      192.168.[0-1].*                     \
                                            #all servers;\
                   o2ib0(ib0)      192.168.[2-253].[0-252/2]       #even cl\
ients;\
                   o2ib1(ib1)      192.168.[2-253].[1-253/2]       #odd cli\
ents&quot;</screen>
      <para>This configuration gives every server two NIDs, one on each network, and statically load-balances clients between the rails.</para>
      <itemizedlist>
        <listitem>
          <para>A single client that must get two rails of bandwidth, and it does not matter if the maximum aggregate bandwidth is only (# servers) * (1 rail).</para>
        </listitem>
      </itemizedlist>
      <screen>ip2nets=&quot;       o2ib0(ib0)                      192.168.[0-1].[0-252/2]     \
                                            #even servers;\
           o2ib1(ib1)                      192.168.[0-1].[1-253/2]         \
                                        #odd servers;\
           o2ib0(ib0),o2ib1(ib1)           192.168.[2-253].*               \
                                        #clients&quot;</screen>
      <para>This configuration gives every server a single NID on one rail or the other. Clients have a NID on both rails.</para>
      <itemizedlist>
        <listitem>
          <para>All clients and all servers must get two rails of bandwidth.</para>
        </listitem>
      </itemizedlist>
      <screen>ip2nets=â€   o2ib0(ib0),o2ib2(ib1)           192.168.[0-1].[0-252/2]       \
  #even servers;\
           o2ib1(ib0),o2ib3(ib1)           192.168.[0-1].[1-253/2]         \
#odd servers;\
           o2ib0(ib0),o2ib3(ib1)           192.168.[2-253].[0-252/2)       \
#even clients;\
           o2ib1(ib0),o2ib2(ib1)           192.168.[2-253].[1-253/2)       \
#odd clients&quot;</screen>
      <para>This configuration includes two additional proxy o2ib networks to work around the
        simplistic NID selection algorithm in the Lustre software. It connects &quot;even&quot;
        clients to &quot;even&quot; servers with <literal>o2ib0</literal> on
          <literal>rail0</literal>, and &quot;odd&quot; servers with <literal>o2ib3</literal> on
          <literal>rail1</literal>. Similarly, it connects &quot;odd&quot; clients to
        &quot;odd&quot; servers with <literal>o2ib1</literal> on <literal>rail0</literal>, and
        &quot;even&quot; servers with <literal>o2ib2</literal> on <literal>rail1</literal>.</para>
    </section>
  </section>
  <section xml:id="managinglnet.configuringroutes">
    <title><indexterm><primary>LNet</primary></indexterm>Dynamically Configuring
    LNet Routes</title>
    <para>Two scripts are provided:
    <literal>lustre/scripts/lustre_routes_config</literal> and
    <literal>lustre/scripts/lustre_routes_conversion</literal>.</para>
    <para><literal>lustre_routes_config</literal> sets or cleans up LNet routes
    from the specified config file.  The
    <literal>/etc/sysconfig/lnet_routes.conf</literal> file can be used to
    automatically configure routes on LNet startup. </para>
    <para><literal>lustre_routes_conversion</literal> converts a legacy routes
    configuration file to the new syntax, which is parsed by
    <literal>lustre_routes_config</literal>.</para>
    <section remap="h3">
      <title><indexterm><primary>LNet</primary></indexterm>
      <literal>lustre_routes_config</literal></title>
      <para><literal>lustre_routes_config</literal> usage is as follows</para>
      <screen><literal>lustre_routes_config [--setup|--cleanup|--dry-run|--verbose] <replaceable>config_file</replaceable></literal>
         --setup: configure routes listed in config_file
         --cleanup: unconfigure routes listed in config_file
         --dry-run: echo commands to be run, but do not execute them
         --verbose: echo commands before they are executed </screen>
      <para> The format of the file which is passed into the script is as
      follows: </para>
      <para><literal><replaceable>network</replaceable>: { gateway: <replaceable>gateway</replaceable>@<replaceable>exit_network</replaceable> [hop: <replaceable>hop</replaceable>] [priority: <replaceable>priority</replaceable>] }</literal></para>
      <para> An LNet router is identified when its local NID appears within the
      list of routes.  However, this can not be achieved by the use of this
      script, since the script only adds extra routes after the router is
      identified.  To ensure that a router is identified correctly, make sure to
      add its local NID in the routes parameter in the modprobe lustre
      configuration file.
      See <xref linkend='dbdoclet.tuning_lnet_mod_params'/>.</para>
    </section>
    <section remap="h3">
      <title><indexterm><primary>LNet</primary></indexterm><literal>lustre_routes_conversion</literal></title>
      <para><literal>lustre_routes_conversion</literal> usage is as follows:</para>
      <screen><literal>lustre_routes_conversion <replaceable>legacy_file</replaceable> <replaceable>new_file</replaceable></literal></screen>
      <para><literal>lustre_routes_conversion</literal> takes as a first parameter a file with routes configured as follows:</para>
      <para><literal><replaceable>network</replaceable> [<replaceable>hop</replaceable>] <replaceable>gateway</replaceable>@<replaceable>exit network</replaceable>[:<replaceable>priority</replaceable>];</literal></para>
      <para>The script then converts each routes entry in the provided file to:</para>
      <para><literal><replaceable>network</replaceable>: { gateway: <replaceable>gateway</replaceable>@<replaceable>exit network</replaceable> [hop: <replaceable>hop</replaceable>] [priority: <replaceable>priority</replaceable>] }</literal></para>
      <para>and appends each converted entry to the output file passed in as the second parameter to the script.</para>
    </section>
    <section remap="h3">
      <title><indexterm><primary>LNet</primary></indexterm><literal>Route Configuration Examples</literal></title>
      <para>Below is an example of a legacy LNet route configuration.  A legacy configuration file can have multiple entries.</para>
      <screen><literal>tcp1 10.1.1.2@tcp0:1;
tcp2 10.1.1.3@tcp0:2;
tcp3 10.1.1.4@tcp0;</literal></screen>
      <para>Below is an example of the converted LNet route configuration.  The following would be the result of the <literal>lustre_routes_conversion</literal> script, when run on the above legacy entries.</para>
      <screen><literal>tcp1: { gateway: 10.1.1.2@tcp0 priority: 1 }
tcp2: { gateway: 10.1.1.2@tcp0 priority: 2 }
tcp1: { gateway: 10.1.1.4@tcp0 }</literal></screen>
    </section>
  </section>
</chapter>
<!--vim:expandtab:shiftwidth=2:tabstop=8:-->
