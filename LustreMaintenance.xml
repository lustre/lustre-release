<?xml version='1.0' encoding='UTF-8'?><chapter xmlns="http://docbook.org/ns/docbook" xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en-US" xml:id="lustremaintenance">
  <title xml:id="lustremaintenance.title">Lustre Maintenance</title>
  <para>Once you have the Lustre file system up and running, you can use the procedures in this section to perform these basic Lustre maintenance tasks:</para>
  <itemizedlist>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_42877"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_15240"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_26070"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_54623"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_31353"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.addingamdt"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_22527"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_14978"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.rmremotedir"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.inactivemdt"/>\</para>
    </listitem>
    <listitem>
      <para><xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="section_k3l_4gt_tl"/></para>
    </listitem>
    <listitem>
      <para><xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="section_ydg_pgt_tl"/></para>
    </listitem>
    <listitem>
      <para><xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="section_kzs_pgt_tl"/></para>
    </listitem>
    <listitem>
      <para><xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="section_ucf_qgt_tl"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_77819"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_12607"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_62333"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438199_62545"/></para>
    </listitem>
  </itemizedlist>
  <section xml:id="dbdoclet.50438199_42877">
      <title>
          <indexterm><primary>maintenance</primary></indexterm>
          <indexterm><primary>maintenance</primary><secondary>inactive OSTs</secondary></indexterm>
          Working with Inactive OSTs</title>
    <para>To mount a client or an MDT with one or more inactive OSTs, run commands similar to this:</para>
    <screen>client# mount -o exclude=testfs-OST0000 -t lustre \
           uml1:/testfs /mnt/testfs
            client# cat /proc/fs/lustre/lov/testfs-clilov-*/target_obd</screen>
    <para>To activate an inactive OST on a live client or MDT, use the <literal>lctl activate</literal> command on the OSC device. For example:</para>
    <screen>lctl --device 7 activate</screen>
    <note>
      <para>A colon-separated list can also be specified. For example, <literal>exclude=testfs-OST0000:testfs-OST0001</literal>.</para>
    </note>
    </section>
    <section xml:id="dbdoclet.50438199_15240">
      <title><indexterm><primary>maintenance</primary><secondary>finding nodes</secondary></indexterm>
Finding Nodes in the Lustre File System</title>
      <para>There may be situations in which you need to find all nodes in your Lustre file system or get the names of all OSTs.</para>
      <para>To get a list of all Lustre nodes, run this command on the MGS:</para>
      <screen># cat /proc/fs/lustre/mgs/MGS/live/*</screen>
      <note>
        <para>This command must be run on the MGS.
                </para>
      </note>
      <para>In this example, file system <literal>testfs</literal> has three nodes,
        <literal>testfs-MDT0000</literal>, <literal>testfs-OST0000</literal>, and
        <literal>testfs-OST0001</literal>.</para>
      <screen>cfs21:/tmp# cat /proc/fs/lustre/mgs/MGS/live/* 
                fsname: testfs 
                flags: 0x0     gen: 26 
                testfs-MDT0000 
                testfs-OST0000 
                testfs-OST0001 </screen>
      <para>To get the names of all OSTs, run this command on the MDS:</para>
      <screen># cat /proc/fs/lustre/lov/<replaceable>fsname</replaceable>-mdtlov/target_obd </screen>
      <note>
        <para>This command must be run on the MDS.
                </para>
      </note>
      <para>In this example, there are two OSTs, testfs-OST0000 and testfs-OST0001, which are both
      active.</para>
      <screen>cfs21:/tmp# cat /proc/fs/lustre/lov/testfs-mdtlov/target_obd 
0: testfs-OST0000_UUID ACTIVE 
1: testfs-OST0001_UUID ACTIVE </screen>
    </section>
    <section xml:id="dbdoclet.50438199_26070">
      <title><indexterm><primary>maintenance</primary><secondary>mounting a server</secondary></indexterm>
Mounting a Server Without Lustre Service</title>
      <para>If you are using a combined MGS/MDT, but you only want to start the MGS and not the MDT, run this command:</para>
      <screen>mount -t lustre <replaceable>/dev/mdt_partition</replaceable> -o nosvc <replaceable>/mount_point</replaceable></screen>
      <para>The <literal><replaceable>mdt_partition</replaceable></literal> variable is the combined MGS/MDT block device.</para>
      <para>In this example, the combined MGS/MDT is <literal>testfs-MDT0000</literal> and the mount point is <literal>/mnt/test/mdt</literal>.</para>
      <screen>$ mount -t lustre -L testfs-MDT0000 -o nosvc /mnt/test/mdt</screen>
    </section>
    <section xml:id="dbdoclet.50438199_54623">
      <title><indexterm><primary>maintenance</primary><secondary>regenerating config logs</secondary></indexterm>
Regenerating Lustre Configuration Logs</title>
      <para>If the Lustre file system configuration logs are in a state where the file system cannot
      be started, use the <literal>writeconf</literal> command to erase them. After the
        <literal>writeconf</literal> command is run and the servers restart, the configuration logs
      are re-generated and stored on the MGS (as in a new file system).</para>
      <para>You should only use the <literal>writeconf</literal> command if:</para>
      <itemizedlist>
        <listitem>
          <para>The configuration logs are in a state where the file system cannot start</para>
        </listitem>
        <listitem>
          <para>A server NID is being changed</para>
        </listitem>
      </itemizedlist>
      <para>The <literal>writeconf</literal> command is destructive to some configuration items (i.e., OST pools information and items set via <literal>conf_param</literal>), and should be used with caution. To avoid problems:</para>
      <itemizedlist>
        <listitem>
          <para>Shut down the file system before running the <literal>writeconf</literal> command</para>
        </listitem>
        <listitem>
          <para>Run the <literal>writeconf</literal> command on all servers (MDT first, then OSTs)</para>
        </listitem>
        <listitem>
          <para>Start the file system in this order:</para>
          <itemizedlist>
            <listitem>
              <para>MGS (or the combined MGS/MDT)</para>
            </listitem>
            <listitem>
              <para>MDT</para>
            </listitem>
            <listitem>
              <para>OSTs</para>
            </listitem>
            <listitem>
              <para>Lustre clients</para>
            </listitem>
          </itemizedlist>
        </listitem>
      </itemizedlist>
      <caution>
        <para>The OST pools feature enables a group of OSTs to be named for file striping purposes. If you use OST pools, be aware that running the <literal>writeconf</literal> command erases <emphasis role="bold">all</emphasis> pools information (as well as any other parameters set via <literal>lctl conf_param</literal>). We recommend that the pools definitions (and <literal>conf_param</literal> settings) be executed via a script, so they can be reproduced easily after a <literal>writeconf</literal> is performed.</para>
      </caution>
      <para>To regenerate Lustre file system configuration logs:</para>
      <orderedlist>
        <listitem>
          <para>Shut down the file system in this order.</para>
          <orderedlist>
            <listitem>
              <para>Unmount the clients.</para>
            </listitem>
            <listitem>
              <para>Unmount the MDT.</para>
            </listitem>
            <listitem>
              <para>Unmount all OSTs.</para>
            </listitem>
          </orderedlist>
        </listitem>
        <listitem>
          <para>Make sure the the MDT and OST devices are available.</para>
        </listitem>
        <listitem>
          <para>Run the <literal>writeconf</literal> command on all servers.</para>
          <para>Run writeconf on the MDT first, and then the OSTs.</para>
          <orderedlist>
            <listitem>
              <para>On the MDT, run:</para>
              <screen>mdt# tunefs.lustre --writeconf <replaceable>/dev/mdt_device</replaceable></screen>
            </listitem>
            <listitem>
              <para>
              On each OST, run:
              
          <screen>ost# tunefs.lustre --writeconf <replaceable>/dev/ost_device</replaceable></screen>
          </para>
            </listitem>
          </orderedlist>
        </listitem>
        <listitem>
          <para>Restart the file system in this order.</para>
          <orderedlist>
            <listitem>
              <para>Mount the MGS (or the combined MGS/MDT).</para>
            </listitem>
            <listitem>
              <para>Mount the MDT.</para>
            </listitem>
            <listitem>
              <para>Mount the OSTs.</para>
            </listitem>
            <listitem>
              <para>Mount the clients.</para>
            </listitem>
          </orderedlist>
        </listitem>
      </orderedlist>
      <para>After the <literal>writeconf</literal> command is run, the configuration logs are re-generated as servers restart.</para>
    </section>
    <section xml:id="dbdoclet.50438199_31353">
      <title><indexterm><primary>maintenance</primary><secondary>changing a NID</secondary></indexterm>
Changing a Server NID</title>
      <para>In Lustre software release 2.3 or earlier, the <literal>tunefs.lustre
        --writeconf</literal> command is used to rewrite all of the configuration files.</para>
      <para condition="l24">If you need to change the NID on the MDT or OST, a new
        <literal>replace_nids</literal> command was added in Lustre software release 2.4 to simplify
      this process. The <literal>replace_nids</literal> command differs from <literal>tunefs.lustre
        --writeconf</literal> in that it does not erase the entire configuration log, precluding the
      need the need to execute the <literal>writeconf</literal> command on all servers and
      re-specify all permanent parameter settings. However, the <literal>writeconf</literal> command
      can still be used if desired.</para>
      <para>Change a server NID in these situations:</para>
      <itemizedlist>
        <listitem>
          <para>New server hardware is added to the file system, and the MDS or an OSS is being moved to the new machine.</para>
        </listitem>
        <listitem>
          <para>New network card is installed in the server.</para>
        </listitem>
        <listitem>
          <para>You want to reassign IP addresses.</para>
        </listitem>
      </itemizedlist>
      <para>To change a server NID:</para>
      <orderedlist>
        <listitem>
		<para>Update the LNET configuration in the <literal>/etc/modprobe.conf</literal> file so the list of server NIDs is correct. Use <literal>lctl list_nids</literal> to view the list of server NIDS.</para>
          <para>The <literal>lctl list_nids</literal> command indicates which network(s) are
          configured to work with the Lustre file system.</para>
        </listitem>
        <listitem>
          <para>Shut down the file system in this order:</para>
          <orderedlist>
            <listitem>
              <para>Unmount the clients.</para>
            </listitem>
            <listitem>
              <para>Unmount the MDT.</para>
            </listitem>
            <listitem>
              <para>Unmount all OSTs.</para>
            </listitem>
          </orderedlist>
        </listitem>
	<listitem>
	  <para>If the MGS and MDS share a partition, start the MGS only:</para>
          <screen>mount -t lustre <replaceable>MDT partition</replaceable> -o nosvc <replaceable>mount_point</replaceable></screen>
	</listitem>
        <listitem>
	  <para>Run the <literal>replace_nids</literal> command on the MGS:</para>
	  <screen>lctl replace_nids <replaceable>devicename</replaceable> <replaceable>nid1</replaceable>[,nid2,nid3 ...]</screen>
	  <para>where <replaceable>devicename</replaceable> is the Lustre target name, e.g.
            <literal>testfs-OST0013</literal></para>
        </listitem>
        <listitem>
          <para>If the MGS and MDS share a partition, stop the MGS:</para>
          <screen>umount <replaceable>mount_point</replaceable></screen>
        </listitem>
      </orderedlist>
      <note><para>The <literal>replace_nids</literal> command also cleans
      all old, invalidated records out of the configuration log, while
      preserving all other current settings.</para></note> 
      <note><para>The previous configuration log is backed up on the MGS
      disk with the suffix <literal>'.bak'</literal>.</para></note>
    </section>
    <section xml:id="dbdoclet.addingamdt" condition='l24'>
      <title><indexterm>
        <primary>maintenance</primary>
        <secondary>adding an MDT</secondary>
      </indexterm>Adding a New MDT to a Lustre File System</title>
        <para>Additional MDTs can be added using the DNE feature to serve one
        or more remote sub-directories within a filesystem, in order to
        increase the total number of files that can be created in the
        filesystem, to increase aggregate metadata performance, or to isolate
        user or application workloads from other users of the filesystem. It
        is possible to have multiple remote sub-directories reference the
        same MDT.  However, the root directory will always be located on
        MDT0. To add a new MDT into the file system:</para>
      <orderedlist>
        <listitem>
          <para>Discover the maximum MDT index. Each MDTs must have unique index.</para>
<screen>
client$ lctl dl | grep mdc
36 UP mdc testfs-MDT0000-mdc-ffff88004edf3c00 4c8be054-144f-9359-b063-8477566eb84e 5
37 UP mdc testfs-MDT0001-mdc-ffff88004edf3c00 4c8be054-144f-9359-b063-8477566eb84e 5
38 UP mdc testfs-MDT0002-mdc-ffff88004edf3c00 4c8be054-144f-9359-b063-8477566eb84e 5
39 UP mdc testfs-MDT0003-mdc-ffff88004edf3c00 4c8be054-144f-9359-b063-8477566eb84e 5
</screen>
        </listitem>
        <listitem>
          <para>Add the new block device as a new MDT at the next available
          index. In this example, the next available index is 4.</para>
<screen>
mds# mkfs.lustre --reformat --fsname=<replaceable>testfs</replaceable> --mdt --mgsnode=<replaceable>mgsnode</replaceable> --index 4 <replaceable>/dev/mdt4_device</replaceable>
</screen>
        </listitem>
        <listitem>
          <para>Mount the MDTs.</para>
<screen>
mds# mount –t lustre <replaceable>/dev/mdt4_blockdevice</replaceable> /mnt/mdt4
</screen>
        </listitem>
      </orderedlist>
    </section>
    <section xml:id="dbdoclet.50438199_22527">
      <title><indexterm><primary>maintenance</primary><secondary>adding a OST</secondary></indexterm>
Adding a New OST to a Lustre File System</title>
      <para>To add an OST to existing Lustre file system:</para>
      <orderedlist>
        <listitem>
          <para> Add a new OST by passing on the following commands, run:</para>
          <screen>oss# mkfs.lustre --fsname=spfs --mgsnode=mds16@tcp0 --ost --index=12 /dev/sda
oss# mkdir -p /mnt/test/ost12
oss# mount -t lustre /dev/sda /mnt/test/ost12</screen>
        </listitem>
        <listitem>
          <para> Migrate the data (possibly).</para>
          <para>The file system is quite unbalanced when new empty OSTs are added. New file creations are automatically balanced. If this is a scratch file system or files are pruned at a regular interval, then no further work may be needed.</para>
          <para>New files being created will preferentially be placed on the empty OST. As old files are deleted, they will release space on the old OST.</para>
          <para>Files existing prior to the expansion can optionally be rebalanced with an in-place copy, which can be done with a simple script. The basic method is to copy existing files to a temporary file, then move the temp file over the old one. This should not be attempted with files which are currently being written to by users or applications. This operation redistributes the stripes over the entire set of OSTs.</para>
          <para>For example, to rebalance all files within <literal>/mnt/lustre/dir</literal>, enter:</para>
          <screen>client# lfs_migrate /mnt/lustre/file</screen>
          <para>To migrate files within the <literal>/test</literal> file system on
            <literal>OST0004</literal> that are larger than 4GB in size, enter:</para>
          <screen>client# lfs find /test -obd test-OST0004 -size +4G | lfs_migrate -y</screen>
          <para>See <xref linkend="dbdoclet.50438206_42260"/>  for more details.</para>
        </listitem>
      </orderedlist>
    </section>
    <section xml:id="dbdoclet.50438199_14978">
      <title><indexterm><primary>maintenance</primary><secondary>restoring a OST</secondary></indexterm>
      <indexterm><primary>maintenance</primary><secondary>removing a OST</secondary></indexterm>
Removing and Restoring OSTs</title>
      <para>OSTs can be removed from and restored to a Lustre file system. Removing a OST means the
      OST is <emphasis role="italic">deactivated</emphasis> in the file system, not permanently
      removed.</para>
  	  	<note><para>A removed OST still appears in the file system; do not create a new OST with the same name.</para></note>
      <para>You may want to remove (deactivate) an OST and prevent new files from being written to it in several situations:</para>
      <itemizedlist>
        <listitem>
          <para>Hard drive has failed and a RAID resync/rebuild is underway</para>
        </listitem>
        <listitem>
          <para>OST is nearing its space capacity</para>
        </listitem>
        <listitem>
		  <para>OST storage has failed permanently</para>
	    </listitem>
      </itemizedlist>
      <section condition="l24" xml:id="dbdoclet.rmremotedir">
      <title><indexterm><primary>maintenance</primary><secondary>removing a MDT</secondary></indexterm>Removing a MDT from the File System</title>
	<para>If the MDT is permanently inaccessible, <literal>lfs rmdir {directory}</literal> can be used to delete the directory entry. A normal <literal>rmdir</literal> will report an IO error due to the remote MDT being inactive. After the remote directory has been removed, the administrator should mark the MDT as permanently inactive with:</para>
<screen>lctl conf_param {MDT name}.mdc.active=0
</screen>
<para>A user can identify the location of a remote sub-directory using the <literal>lfs</literal> utility. For example:</para>
<screen>client$ lfs getstripe -M /mnt/lustre/remote_dir1
1
client$ mkdir /mnt/lustre/local_dir0
client$ lfs getstripe -M /mnt/lustre/local_dir0
0
</screen>
	<para>The <literal>getstripe -M</literal> parameters return the index of the MDT that is serving the given directory.</para>
	  </section>
	  <section xml:id="dbdoclet.inactivemdt" condition='l24'>
      <title>
          <indexterm><primary>maintenance</primary></indexterm>
          <indexterm><primary>maintenance</primary><secondary>inactive MDTs</secondary></indexterm>Working with Inactive MDTs</title>
    <para>Files located on or below an inactive MDT are inaccessible until the MDT is activated again. Clients accessing an inactive MDT will receive an EIO error.</para></section>
      <section remap="h3" xml:id="section_k3l_4gt_tl">
      <title><indexterm>
          <primary>maintenance</primary>
          <secondary>removing a OST</secondary>
        </indexterm> Removing an OST from the File System</title>
      <para>When removing an OST, remember that the MDT does not communicate directly with OSTs.
        Rather, each OST has a corresponding OSC which communicates with the MDT. It is necessary to
        determine the device number of the OSC that corresponds to the OST. Then, you use this
        device number to deactivate the OSC on the MDT.</para>
      <para>To remove an OST from the file system:</para>
      <orderedlist>
        <listitem>
          <para>For the OST to be removed, determine the device number of the corresponding OSC on
            the MDT.</para>
          <orderedlist>
            <listitem>
              <para>List all OSCs on the node, along with their device numbers. Run:</para>
              <screen>lctl dl | grep osc</screen>
              <para>For example: <literal>lctl dl | grep</literal></para>
              <screen>11 UP osc testfs-OST-0000-osc-cac94211 4ea5b30f-6a8e-55a0-7519-2f20318ebdb4 5
12 UP osc testfs-OST-0001-osc-cac94211 4ea5b30f-6a8e-55a0-7519-2f20318ebdb4 5
13 IN osc testfs-OST-0000-osc testfs-MDT0000-mdtlov_UUID 5
14 UP osc testfs-OST-0001-osc testfs-MDT0000-mdtlov_UUID 5</screen>
            </listitem>
            <listitem>
              <para>Determine the device number of the OSC that corresponds to the OST to be
                removed.</para>
            </listitem>
          </orderedlist>
        </listitem>
        <listitem>
          <para>Temporarily deactivate the OSC on the MDT. On the MDT, run: </para>
          <screen>mds# lctl --device <replaceable>lustre_devno</replaceable> deactivate</screen>
          <para>For example, based on the command output in Step 1, to deactivate device 13 (the
            MDT’s OSC for <literal>OST-0000</literal>), the command would be: </para>
          <screen>mds# lctl --device 13 deactivate</screen>
          <para>This marks the OST as inactive on the MDS, so no new objects are assigned to the
            OST. This does not prevent use of existing objects for reads or writes. </para>
          <note>
            <para>Do not deactivate the OST on the clients. Do so causes errors (EIOs), and the copy
              out to fail. </para>
          </note>
          <caution>
            <para>Do not use <literal>lctl conf_param</literal> to deactivate the OST. It
              permanently sets a parameter in the file system configuration.</para>
          </caution>
        </listitem>
        <listitem>
          <para>Discover all files that have objects residing on the deactivated OST. </para>
          <para>Depending on whether the deactivated OST is available or not, the data from that OST
            may be migrated to other OSTs, or may need to be restored from backup. </para>
          <orderedlist>
            <listitem>
              <para>If the OST is still online and available, find all files with objects on the
                deactivated OST, and copy them to other OSTs in the file system to: </para>
              <screen>client# lfs find --obd <replaceable>ost_name</replaceable> <replaceable>/mount/point</replaceable> | lfs_migrate -y</screen>
            </listitem>
            <listitem>
              <para>If the OST is no longer available, delete the files on that OST and restore them
                from backup:
                <screen>client# lfs find --obd <replaceable>ost_uuid</replaceable> -print0 <replaceable>/mount/point</replaceable> | \
           tee /tmp/files_to_restore | xargs -0 -n 1 unlink</screen>
                The list of files that need to be restored from backup is stored in
                  <literal>/tmp/files_to_restore</literal>. Restoring these files is beyond the
                scope of this document.</para>
            </listitem>
          </orderedlist>
        </listitem>
        <listitem>
          <para>Deactivate the OST.</para>
          <orderedlist>
            <listitem>
              <para>To temporarily disable the deactivated OST, enter:
                <screen>[client]# lctl set_param osc.<replaceable>fsname</replaceable>-<replaceable>OSTnumber</replaceable>-*.active=0</screen>If
                there is expected to be a replacement OST in some short time (a few days), the OST
                can temporarily be deactivated on the clients: <note>
                  <para>This setting is only temporary and will be reset if the clients or MDS are
                    rebooted. It needs to be run on all clients.</para>
                </note></para>
            </listitem>
          </orderedlist>
          <para>If there is not expected to be a replacement for this OST in the near future,
            permanently deactivate the OST on all clients and the MDS:
            <screen>[mgs]# lctl conf_param <replaceable>ost_name</replaceable>.osc.active=0</screen></para>
          <note>
            <para>A removed OST still appears in the file system; do not create a new OST with the
              same name.</para>
          </note>
        </listitem>
      </orderedlist>
    </section>
      <section remap="h3" xml:id="section_ydg_pgt_tl">
      <title><indexterm>
          <primary>maintenance</primary>
          <secondary>backing up OST config</secondary>
        </indexterm>
        <indexterm>
          <primary>backup</primary>
          <secondary>OST config</secondary>
        </indexterm> Backing Up OST Configuration Files</title>
      <para>If the OST device is still accessible, then the Lustre configuration files on the OST
        should be backed up and saved for future use in order to avoid difficulties when a
        replacement OST is returned to service. These files rarely change, so they can and should be
        backed up while the OST is functional and accessible. If the deactivated OST is still
        available to mount (i.e. has not permanently failed or is unmountable due to severe
        corruption), an effort should be made to preserve these files. </para>
      <orderedlist>
        <listitem>
          <para>Mount the OST file system.
            <screen>oss# mkdir -p /mnt/ost
[oss]# mount -t ldiskfs <replaceable>/dev/ost_device</replaceable> /mnt/ost</screen>
          </para>
        </listitem>
        <listitem>
          <para>Back up the OST configuration files.
            <screen>oss# tar cvf <replaceable>ost_name</replaceable>.tar -C /mnt/ost last_rcvd \
           CONFIGS/ O/0/LAST_ID</screen>
          </para>
        </listitem>
        <listitem>
          <para> Unmount the OST file system. <screen>oss# umount /mnt/ost</screen>
          </para>
        </listitem>
      </orderedlist>
    </section>
      <section xml:id="section_kzs_pgt_tl">
      <title><indexterm>
          <primary>maintenance</primary>
          <secondary>restoring OST config</secondary>
        </indexterm>
        <indexterm>
          <primary>backup</primary>
          <secondary>restoring OST config</secondary>
        </indexterm> Restoring OST Configuration Files</title>
      <para>If the original OST is still available, it is best to follow the OST backup and restore
        procedure given in either <xref linkend="dbdoclet.50438207_71633"/>, or <xref
          linkend="dbdoclet.50438207_21638"/> and <xref linkend="dbdoclet.50438207_22325"/>. </para>
      <para>To replace an OST that was removed from service due to corruption or hardware failure,
        the file system needs to be formatted using <literal>mkfs.lustre</literal>, and the Lustre
        file system configuration should be restored, if available. </para>
      <para>If the OST configuration files were not backed up, due to the OST file system being
        completely inaccessible, it is still possible to replace the failed OST with a new one at
        the same OST index. </para>
      <orderedlist>
        <listitem>
          <para> Format the OST file system.
            <screen>oss# mkfs.lustre --ost --index=<replaceable>old_ost_index</replaceable> <replaceable>other_options</replaceable> \
           <replaceable>/dev/new_ost_dev</replaceable></screen>
          </para>
        </listitem>
        <listitem>
          <para> Mount the OST file system.
            <screen>oss# mkdir /mnt/ost
oss# mount -t ldiskfs <replaceable>/dev/new_ost_dev</replaceable> <replaceable>/mnt/ost</replaceable></screen>
          </para>
        </listitem>
        <listitem>
          <para>Restore the OST configuration files, if available.
            <screen>oss# tar xvf <replaceable>ost_name</replaceable>.tar -C /mnt/ost</screen></para>
        </listitem>
        <listitem>
          <para>Recreate the OST configuration files, if unavailable. </para>
          <para>Follow the procedure in <xref linkend="dbdoclet.50438198_69657"/> to recreate the
            LAST_ID file for this OST index. The <literal>last_rcvd</literal> file will be recreated
            when the OST is first mounted using the default parameters, which are normally correct
            for all file systems. The <literal>CONFIGS/mountdata</literal> file is created by
              <literal>mkfs.lustre</literal> at format time, but has flags set that request it to
            register itself with the MGS. It is possible to copy these flags from another working
            OST (which should be the same):
            <screen>oss1# debugfs -c -R &quot;dump CONFIGS/mountdata /tmp/ldd&quot; <replaceable>/dev/other_osdev</replaceable>
oss1# scp /tmp/ldd oss0:/tmp/ldd
oss0# dd if=/tmp/ldd of=/mnt/ost/CONFIGS/mountdata bs=4 count=1 seek=5 skip=5 conv=notrunc</screen></para>
        </listitem>
        <listitem>
          <para> Unmount the OST file system. <screen>oss# umount /mnt/ost</screen>
          </para>
        </listitem>
      </orderedlist>
    </section>
      <section xml:id="section_ucf_qgt_tl">
      <title><indexterm>
          <primary>maintenance</primary>
          <secondary>reintroducing an OSTs</secondary>
        </indexterm> Returning a Deactivated OST to Service</title>
      <para> If the OST was permanently deactivated, it needs to be reactivated in the MGS
        configuration.
        <screen>mgs# lctl conf_param <replaceable>ost_name</replaceable>.osc.active=1</screen> If
        the OST was temporarily deactivated, it needs to be reactivated on the MDS and clients.
        <screen>mds# lctl --device <replaceable>lustre_devno</replaceable> activate
                    client# lctl set_param osc.<replaceable>fsname</replaceable>-<replaceable>OSTnumber</replaceable>-*.active=0</screen></para>
    </section>
    </section>
    <section xml:id="dbdoclet.50438199_77819">
      <title><indexterm><primary>maintenance</primary><secondary>aborting recovery</secondary></indexterm>
      <indexterm><primary>backup</primary><secondary>aborting recovery</secondary></indexterm>
Aborting Recovery</title>
      <para>You can abort recovery with either the <literal>lctl</literal> utility or by mounting the target with the <literal>abort_recov</literal> option (<literal>mount -o abort_recov</literal>). When starting a target, run: <screen>mds# mount -t lustre -L <replaceable>mdt_name</replaceable> -o abort_recov <replaceable>/mount_point</replaceable></screen></para>
      <note>
        <para>The recovery process is blocked until all OSTs are available. </para>
      </note>
    </section>
    <section xml:id="dbdoclet.50438199_12607">
      <title><indexterm><primary>maintenance</primary><secondary>identifying OST host</secondary></indexterm>
Determining Which Machine is Serving an OST </title>
      <para>In the course of administering a Lustre file system, you may need to determine which
      machine is serving a specific OST. It is not as simple as identifying the machine’s IP
      address, as IP is only one of several networking protocols that the Lustre software uses and,
      as such, LNET does not use IP addresses as node identifiers, but NIDs instead. To identify the
      NID that is serving a specific OST, run one of the following commands on a client (you do not
      need to be a root user):
      <screen>client$ lctl get_param osc.<replaceable>fsname</replaceable>-<replaceable>OSTnumber</replaceable>*.ost_conn_uuid</screen>For
      example:
      <screen>client$ lctl get_param osc.*-OST0000*.ost_conn_uuid 
osc.testfs-OST0000-osc-f1579000.ost_conn_uuid=192.168.20.1@tcp</screen>-
      OR -
      <screen>client$ lctl get_param osc.*.ost_conn_uuid 
osc.testfs-OST0000-osc-f1579000.ost_conn_uuid=192.168.20.1@tcp
osc.testfs-OST0001-osc-f1579000.ost_conn_uuid=192.168.20.1@tcp
osc.testfs-OST0002-osc-f1579000.ost_conn_uuid=192.168.20.1@tcp
osc.testfs-OST0003-osc-f1579000.ost_conn_uuid=192.168.20.1@tcp
osc.testfs-OST0004-osc-f1579000.ost_conn_uuid=192.168.20.1@tcp</screen></para>
    </section>
    <section xml:id="dbdoclet.50438199_62333">
      <title><indexterm><primary>maintenance</primary><secondary>changing failover node address</secondary></indexterm>
Changing the Address of a Failover Node</title>
      <para>To change the address of a failover node (e.g, to use node X instead of node Y), run
      this command on the OSS/OST partition (depending on which option was used to originally
      identify the NID):
      <screen>oss# tunefs.lustre --erase-params --servicenode=<replaceable>NID</replaceable> <replaceable>/dev/ost_device</replaceable></screen>
      or
      <screen>oss# tunefs.lustre --erase-params --failnode=<replaceable>NID</replaceable> <replaceable>/dev/ost_device</replaceable></screen>
      For more information about the <literal>--servicenode</literal> and
        <literal>--failnode</literal> options, see <xref xmlns:xlink="http://www.w3.org/1999/xlink"
        linkend="configuringfailover"/>.</para>
    </section>
    <section xml:id="dbdoclet.50438199_62545">
      <title><indexterm><primary>maintenance</primary><secondary>separate a combined MGS/MDT</secondary></indexterm>
Separate a combined MGS/MDT</title>
      <para>These instructions assume the MGS node will be the same as the MDS node. For instructions on how to move MGS to a different node, see <xref linkend="dbdoclet.50438199_31353"/>.</para>
      <para>These instructions are for doing the split without shutting down other servers and clients.</para>
      <orderedlist>
        <listitem>
          <para>Stop the MDS.</para>
          <para>Unmount the MDT</para>
	      <screen>umount -f <replaceable>/dev/mdt_device</replaceable> </screen>
        </listitem>
        <listitem>
          <para>Create the MGS.</para>
	      <screen>mds# mkfs.lustre --mgs --device-size=<replaceable>size</replaceable> <replaceable>/dev/mgs_device</replaceable></screen>
        </listitem>
        <listitem>
          <para>Copy the configuration data from MDT disk to the new MGS disk.</para>
	      <screen>mds# mount -t ldiskfs -o ro <replaceable>/dev/mdt_device</replaceable> <replaceable>/mdt_mount_point</replaceable></screen>
	      <screen>mds# mount -t ldiskfs -o rw <replaceable>/dev/mgs_device</replaceable> <replaceable>/mgs_mount_point</replaceable> </screen>
	      <screen>mds# cp -r <replaceable>/mdt_mount_point</replaceable>/CONFIGS/<replaceable>filesystem_name</replaceable>-* <replaceable>/mgs_mount_point</replaceable>/CONFIGS/. </screen>
	      <screen>mds# umount <replaceable>/mgs_mount_point</replaceable></screen>
	      <screen>mds# umount <replaceable>/mdt_mount_point</replaceable></screen>
          <para>See <xref linkend="dbdoclet.50438199_54623"/> for alternative method.</para>
        </listitem>
        <listitem>
          <para>Start the MGS.</para>
	      <screen>mgs# mount -t lustre <replaceable>/dev/mgs_device</replaceable> <replaceable>/mgs_mount_point</replaceable></screen>
          <para>Check to make sure it knows about all your file system</para>
	      <screen>cat /proc/fs/lustre/mgs/MGS/filesystems</screen>
        </listitem>
        <listitem>
          <para>Remove the MGS option from the MDT, and set the new MGS nid.</para>
	      <screen>mds# tunefs.lustre --nomgs --mgsnode=<replaceable>new_mgs_nid</replaceable> <replaceable>/dev/mdt-device</replaceable></screen>
        </listitem>
        <listitem>
          <para>Start the MDT.</para>
	      <screen>mds# mount -t lustre <replaceable>/dev/mdt_device /mdt_mount_point</replaceable></screen>
          <para>Check to make sure the MGS configuration look right</para>
	      <screen>mds# cat /proc/fs/lustre/mgs/MGS/live/<replaceable>filesystem_name</replaceable></screen>
        </listitem>
      </orderedlist>
    </section>
</chapter>
