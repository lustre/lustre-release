<?xml version="1.0" encoding="UTF-8"?>
<chapter version="5.0" xml:lang="en-US" xmlns="http://docbook.org/ns/docbook" xmlns:xl="http://www.w3.org/1999/xlink">
  <info>
    <title>Lustre Programming Interfaces</title>
  </info>
  <para><anchor xml:id="dbdoclet.50438291_pgfId-1293209" xreflabel=""/>This chapter describes public programming interfaces to control various aspects of Lustre from userspace. These interfaces are generally not guaranteed to remain unchanged over time, although we will make an effort to notify the user community well in advance of major changes. This chapter includes the following section:</para>
  <itemizedlist><listitem>
      <para><anchor xml:id="dbdoclet.50438291_pgfId-1294898" xreflabel=""/><anchor xml:id="dbdoclet.50438291_85876" xreflabel=""/><link xl:href="LustreProgrammingInterfaces.html#50438291_32926">User/Group Cache Upcall</link></para>
    </listitem>
<listitem>
      <para> </para>
    </listitem>
<listitem>
      <para><anchor xml:id="dbdoclet.50438291_pgfId-1295238" xreflabel=""/><link xl:href="LustreProgrammingInterfaces.html#50438291_73963">l_getgroups Utility</link></para>
    </listitem>
<listitem>
      <para> </para>
    </listitem>
</itemizedlist>
   <informaltable frame="none">
    <tgroup cols="1">
      <colspec colname="c1" colwidth="100*"/>
      <tbody>
        <row>
          <entry><para><emphasis role="bold">Note -</emphasis><anchor xml:id="dbdoclet.50438291_pgfId-1294899" xreflabel=""/>Lustre programming interface man pages are found in the lustre/doc folder.</para></entry>
        </row>
      </tbody>
    </tgroup>
  </informaltable>
  <section remap="h2">
    <title><anchor xml:id="dbdoclet.50438291_pgfId-1293216" xreflabel=""/></title>
    <section remap="h2">
      <title>33.1 <anchor xml:id="dbdoclet.50438291_32926" xreflabel=""/>User/Group <anchor xml:id="dbdoclet.50438291_marker-1293215" xreflabel=""/>Cache Upcall</title>
      <para><anchor xml:id="dbdoclet.50438291_pgfId-1293217" xreflabel=""/>This section describes user and group upcall.</para>
      <informaltable frame="none">
        <tgroup cols="1">
          <colspec colname="c1" colwidth="100*"/>
          <tbody>
            <row>
              <entry><para><emphasis role="bold">Note -</emphasis><anchor xml:id="dbdoclet.50438291_pgfId-1293379" xreflabel=""/>For information on a universal UID/GID, see <link xl:href="InstallingLustre.html#50438261_19503">Environmental Requirements</link>.</para></entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
      <section remap="h3">
        <title><anchor xml:id="dbdoclet.50438291_pgfId-1293218" xreflabel=""/>33.1.1 Name</title>
        <para><anchor xml:id="dbdoclet.50438291_pgfId-1293219" xreflabel=""/>Use /proc/fs/lustre/mdt/${FSNAME}-MDT{xxxx}/identity_upcall to look up a given userâ€™s group membership.</para>
      </section>
      <section remap="h3">
        <title><anchor xml:id="dbdoclet.50438291_pgfId-1293220" xreflabel=""/>33.1.2 Description</title>
        <para><anchor xml:id="dbdoclet.50438291_pgfId-1293221" xreflabel=""/>The group upcall file contains the path to an executable that, when installed, is invoked to resolve a numeric UID to a group membership list. This utility should complete the mds_grp_downcall_data data structure (see <link xl:href="LustreProgrammingInterfaces.html#50438291_33759">Data Structures</link>) and write it to the /proc/fs/lustre/mdt/${FSNAME}-MDT{xxxx}/identity_info pseudo-file.</para>
        <para><anchor xml:id="dbdoclet.50438291_pgfId-1293225" xreflabel=""/>For a sample upcall program, see lustre/utils/l_getgroups.c in the Lustre source distribution.</para>
        <section remap="h4">
          <title><anchor xml:id="dbdoclet.50438291_pgfId-1293226" xreflabel=""/>33.1.2.1 Primary and Secondary Groups</title>
          <para><anchor xml:id="dbdoclet.50438291_pgfId-1293227" xreflabel=""/>The mechanism for the primary/secondary group is as follows:</para>
          <itemizedlist><listitem>
              <para><anchor xml:id="dbdoclet.50438291_pgfId-1293228" xreflabel=""/> The MDS issues an upcall (set per MDS) to map the numeric UID to the supplementary group(s).</para>
            </listitem>
<listitem>
              <para> </para>
            </listitem>
<listitem>
              <para><anchor xml:id="dbdoclet.50438291_pgfId-1293229" xreflabel=""/> If there is no upcall or if there is an upcall and it fails, supplementary groups will be added as supplied by the client (as they are now).</para>
            </listitem>
<listitem>
              <para> </para>
            </listitem>
<listitem>
              <para><anchor xml:id="dbdoclet.50438291_pgfId-1293230" xreflabel=""/> The default upcall is /usr/sbin/l_getidentity, which can interact with the user/group database to obtain UID/GID/suppgid. The user/group database depends on authentication configuration, and can be local /etc/passwd, NIS, LDAP, etc. If necessary, the administrator can use a parse utility to set /proc/fs/lustre/mdt/${FSNAME}-MDT{xxxx}/identity_upcall. If the upcall interface is set to NONE, then upcall is disabled. The MDS uses the UID/GID/suppgid supplied by the client.</para>
            </listitem>
<listitem>
              <para> </para>
            </listitem>
<listitem>
              <para><anchor xml:id="dbdoclet.50438291_pgfId-1293231" xreflabel=""/> The default group upcall is set by mkfs.lustre. Use tunefs.lustre --param or echo{path}&gt;/proc/fs/lustre/mds/{mdsname}/group_upcall</para>
            </listitem>
<listitem>
              <para> </para>
            </listitem>
<listitem>
              <para><anchor xml:id="dbdoclet.50438291_pgfId-1294341" xreflabel=""/> The Lustre administrator can specify permissions for a specific UID by configuring /etc/lustre/perm.conf on the MDS. As commented in lustre/utils/l_getidentity.c</para>
            </listitem>
<listitem>
              <para> </para>
            </listitem>
</itemizedlist>
          <screen><anchor xml:id="dbdoclet.50438291_pgfId-1294527" xreflabel=""/>/** permission file format is like this: * {nid} {uid} {perms} * * &apos;*&apos; nid \
means any nid* &apos;*&apos; uid means any uid* the valid values for perms are:* setu\
id/setgid/setgrp/rmtacl -- enable corresponding perm* nosetuid/nosetgid/nos\
etgrp/normtacl -- disable corresponding perm* they can be listed together, \
seperated by &apos;,&apos;,* when perm and noperm are in the same line (item), noperm\
 is preferential,* when they are in different lines (items), the latter is \
preferential,* &apos;*&apos; nid is as default perm, and is not preferential.*/
</screen>
          <para><anchor xml:id="dbdoclet.50438291_pgfId-1294343" xreflabel=""/>Currently, rmtacl/normtacl can be ignored (part of security functionality), and used for remote clients. The /usr/sbin/l_getidentity utility can parse /etc/lustre/perm.conf to obtain permission mask for specified UID.</para>
          <itemizedlist><listitem>
              <para><anchor xml:id="dbdoclet.50438291_pgfId-1294268" xreflabel=""/> To avoid repeated upcalls, the MDS caches supplemental group information. Use /proc/fs/lustre/mdt/${FSNAME}-MDT{xxxx}/identity_expire to set the cache time (default is 600 seconds). The kernel waits for the upcall to complete (at most, 5 seconds) and takes the &quot;failure&quot; behavior as described. Set the wait time in /proc/fs/lustre/mdt/${FSNAME}-MDT{xxxx}/identity_acquire_expire (default is 15 seconds). Cached entries are flushed by writing to /proc/fs/lustre/mdt/${FSNAME}-MDT{xxxx}/identity_flush.</para>
            </listitem>
<listitem>
              <para> </para>
            </listitem>
</itemizedlist>
        </section>
      </section>
      <section remap="h3">
        <title><anchor xml:id="dbdoclet.50438291_pgfId-1293233" xreflabel=""/>33.1.3 Parameters</title>
        <itemizedlist><listitem>
            <para><anchor xml:id="dbdoclet.50438291_pgfId-1293234" xreflabel=""/> Name of the MDS service</para>
          </listitem>
<listitem>
            <para> </para>
          </listitem>
<listitem>
            <para><anchor xml:id="dbdoclet.50438291_pgfId-1293235" xreflabel=""/> Numeric UID</para>
          </listitem>
<listitem>
            <para> </para>
          </listitem>
</itemizedlist>
      </section>
      <section remap="h3">
        <title><anchor xml:id="dbdoclet.50438291_pgfId-1293237" xreflabel=""/>33.1.4 <anchor xml:id="dbdoclet.50438291_33759" xreflabel=""/>Data Structures</title>
        <screen><anchor xml:id="dbdoclet.50438291_pgfId-1293240" xreflabel=""/>struct identity_downcall_data {
<anchor xml:id="dbdoclet.50438291_pgfId-1293241" xreflabel=""/>   __u32           idd_magic;
<anchor xml:id="dbdoclet.50438291_pgfId-1293242" xreflabel=""/>   __u32           idd_err;
<anchor xml:id="dbdoclet.50438291_pgfId-1293243" xreflabel=""/>   __u32           idd_uid;
<anchor xml:id="dbdoclet.50438291_pgfId-1293244" xreflabel=""/>   __u32           idd_gid;
<anchor xml:id="dbdoclet.50438291_pgfId-1293245" xreflabel=""/>   __u32           idd_nperms;
<anchor xml:id="dbdoclet.50438291_pgfId-1294332" xreflabel=""/>   struct perm_downcall_data idd_perms[N_PERMS_MAX];
<anchor xml:id="dbdoclet.50438291_pgfId-1294322" xreflabel=""/>   __u32           idd_ngroups;
<anchor xml:id="dbdoclet.50438291_pgfId-1293246" xreflabel=""/>   __u32           idd_groups[0];
<anchor xml:id="dbdoclet.50438291_pgfId-1293247" xreflabel=""/>};
</screen>
      </section>
    </section>
    <section remap="h2">
      <title>33.2 l_getgroups<anchor xml:id="dbdoclet.50438291_73963" xreflabel=""/><anchor xml:id="dbdoclet.50438291_marker-1294565" xreflabel=""/> Utility</title>
      <para><anchor xml:id="dbdoclet.50438291_pgfId-1294567" xreflabel=""/>The l_getgroups utility handles Lustre user/group cache upcall.</para>
      <section remap="h5">
        <title><anchor xml:id="dbdoclet.50438291_pgfId-1294568" xreflabel=""/>Synopsis</title>
        <screen><anchor xml:id="dbdoclet.50438291_pgfId-1294569" xreflabel=""/>l_getgroups [-v] [-d|mdsname] uid]
<anchor xml:id="dbdoclet.50438291_pgfId-1294570" xreflabel=""/>l_getgroups [-v] -s
</screen>
      </section>
      <section remap="h5">
        <title><anchor xml:id="dbdoclet.50438291_pgfId-1294571" xreflabel=""/>Description</title>
        <para><anchor xml:id="dbdoclet.50438291_pgfId-1294572" xreflabel=""/>The group upcall file contains the path to an executable that, when properly installed, is invoked to resolve a numeric UID to a group membership list. This utility should complete the mds_grp_downcall_data data structure (see Data structures) and write it to the /proc/fs/lustre/mds/mds-service/group_info pseudo-file.</para>
        <para><anchor xml:id="dbdoclet.50438291_pgfId-1294573" xreflabel=""/>l_getgroups is the reference implementation of the user/group cache upcall.</para>
      </section>
      <section remap="h5">
        <title><anchor xml:id="dbdoclet.50438291_pgfId-1294574" xreflabel=""/>Files</title>
        <para><anchor xml:id="dbdoclet.50438291_pgfId-1294575" xreflabel=""/>/proc/fs/lustre/mds/mds-service/group_upcall</para>
      </section>
    </section>
  </section>
</chapter>
