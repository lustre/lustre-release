<?xml version='1.0' encoding='UTF-8'?><chapter xmlns="http://docbook.org/ns/docbook" xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en-US" xml:id="configurationfilesmoduleparameters">
    <title xml:id="configurationfilesmoduleparameters.title">Configuration Files and Module Parameters</title>
  <para>This section describes configuration files and module parameters and includes the following sections:</para>
  <itemizedlist>
    <listitem>
      <para><xref linkend="dbdoclet.50438293_15350"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438293_78010"/></para>
    </listitem>
  </itemizedlist>
  <section xml:id="dbdoclet.50438293_15350">
      <title>
          <indexterm><primary>configuring</primary></indexterm>
          <indexterm><primary>LNET</primary><see>configuring</see></indexterm>
          
          
          Introduction</title>
    <para>LNET network hardware and routing are now configured via module parameters. Parameters should be specified in the <literal>/etc/modprobe.d/lustre.conf</literal>file, for example:</para>
    <screen>options lnet networks=tcp0(eth2)</screen>
    <para>The above option specifies that this node should use the TCP protocol on the eth2 network interface.</para>
    <para>Module parameters are read when the module is first loaded. Type-specific LND modules (for instance, <literal>ksocklnd</literal>) are loaded automatically by the LNET module when LNET starts (typically upon <literal>modprobe ptlrpc</literal>).</para>
    <para>LNET configuration parameters can be viewed under <literal>/sys/module/lnet/parameters/</literal>, and LND-specific parameters under the name of the corresponding LND, for example <literal>/sys/module/ksocklnd/parameters/</literal> for the socklnd (TCP) LND.</para>
    <para>For the following parameters, default option settings are shown in parenthesis. Changes to parameters marked with a W affect running systems. Unmarked parameters can only be set when LNET loads for the first time.  Changes to parameters marked with <literal>Wc</literal> only have effect when connections are established (existing connections are not affected by these changes.)</para>
  </section>
  <section xml:id="dbdoclet.50438293_78010">
      <title>
          <indexterm><primary>configuring</primary><secondary>module options</secondary></indexterm>
          
          Module Options</title>
    <itemizedlist>
      <listitem>
        <para>With routed or other multi-network configurations, use <literal>ip2nets</literal> rather than networks, so all nodes can use the same configuration.</para>
      </listitem>
      <listitem>
        <para>For a routed network, use the same &apos;routes&apos; configuration everywhere. Nodes specified as routers automatically enable forwarding and any routes that are not relevant to a particular node are ignored. Keep a common configuration to guarantee that all nodes have consistent routing tables.</para>
      </listitem>
      <listitem>
        <para>A separate <literal>lustre.conf</literal> file makes distributing the configuration much easier.</para>
      </listitem>
      <listitem>
        <para>If you set <literal>config_on_load=1</literal>, LNET starts at
            <literal>modprobe</literal> time rather than waiting for the Lustre file system to
          start. This ensures routers start working at module load time.</para>
      </listitem>
    </itemizedlist>
    <screen># lctl 
# lctl&gt; net down</screen>
    <itemizedlist>
      <listitem>
        <para>Remember the <literal>lctl ping {nid}</literal> command - it is a handy way to check your LNET configuration.</para>
      </listitem>
    </itemizedlist>
    <section remap="h3">
      <title><indexterm><primary>configuring</primary><secondary>LNET options</secondary></indexterm>
LNET Options</title>
      <para>This section describes LNET options.</para>
      <section remap="h4">
        <title><indexterm><primary>configuring</primary><secondary>network topology</secondary></indexterm>
Network Topology</title>
        <para>Network topology module parameters determine which networks a node should join, whether it should route between these networks, and how it communicates with non-local networks.</para>
        <para>Here is a list of various networks and the supported software stacks:</para>
        <informaltable frame="all">
          <tgroup cols="2">
            <colspec colname="c1" colwidth="50*"/>
            <colspec colname="c2" colwidth="50*"/>
            <thead>
              <row>
                <entry>
                  <para><emphasis role="bold">Network</emphasis></para>
                </entry>
                <entry>
                  <para><emphasis role="bold">Software Stack</emphasis></para>
                </entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>
                  <para> o2ib</para>
                </entry>
                <entry>
                  <para> OFED Version 2</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para> mx</para>
                </entry>
                <entry>
                  <para> Myrinet MX</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para> gm</para>
                </entry>
                <entry>
                  <para> Myrinet GM-2</para>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </informaltable>
        <note>
          <para>The Lustre software ignores the loopback interface (<literal>lo0</literal>), but the
            Lustre file system uses any IP addresses aliased to the loopback (by default). When in
            doubt, explicitly specify networks.</para>
        </note>
        <para><literal>ip2nets</literal> (&quot;&quot;) is a string that lists globally-available networks, each with a set of IP address ranges. LNET determines the locally-available networks from this list by matching the IP address ranges with the local IPs of a node. The purpose of this option is to be able to use the same <literal>modules.conf</literal> file across a variety of nodes on different networks. The string has the following syntax.</para>
        <screen>&lt;ip2nets&gt; :== &lt;net-match&gt; [ &lt;comment&gt; ] { &lt;net-sep&gt; &lt;net-match&gt; }
&lt;net-match&gt; :== [ &lt;w&gt; ] &lt;net-spec&gt; &lt;w&gt; &lt;ip-range&gt; { &lt;w&gt; &lt;ip-range&gt; }
[ &lt;w&gt; ]
&lt;net-spec&gt; :== &lt;network&gt; [ &quot;(&quot; &lt;interface-list&gt; &quot;)&quot; ]
&lt;network&gt; :== &lt;nettype&gt; [ &lt;number&gt; ]
&lt;nettype&gt; :== &quot;tcp&quot; | &quot;elan&quot; | &quot;openib&quot; | ...
&lt;iface-list&gt; :== &lt;interface&gt; [ &quot;,&quot; &lt;iface-list&gt; ]
&lt;ip-range&gt; :== &lt;r-expr&gt; &quot;.&quot; &lt;r-expr&gt; &quot;.&quot; &lt;r-expr&gt; &quot;.&quot; &lt;r-expr&gt;
&lt;r-expr&gt; :== &lt;number&gt; | &quot;*&quot; | &quot;[&quot; &lt;r-list&gt; &quot;]&quot;
&lt;r-list&gt; :== &lt;range&gt; [ &quot;,&quot; &lt;r-list&gt; ]
&lt;range&gt; :== &lt;number&gt; [ &quot;-&quot; &lt;number&gt; [ &quot;/&quot; &lt;number&gt; ] ]
&lt;comment :== &quot;#&quot; { &lt;non-net-sep-chars&gt; }
&lt;net-sep&gt; :== &quot;;&quot; | &quot;\n&quot;
&lt;w&gt; :== &lt;whitespace-chars&gt; { &lt;whitespace-chars&gt; }
</screen>
        <para><literal>&lt;net-spec&gt;</literal> contains enough information to uniquely identify the network and load an appropriate LND. The LND determines the missing &quot;address-within-network&quot; part of the NID based on the interfaces it can use.</para>
        <para><literal>&lt;iface-list&gt;</literal> specifies which hardware interface the network can use. If omitted, all interfaces are used. LNDs that do not support the <literal>&lt;iface-list&gt;</literal> syntax cannot be configured to use particular interfaces and just use what is there. Only a single instance of these LNDs can exist on a node at any time, and <literal>&lt;iface-list&gt;</literal> must be omitted.</para>
        <para><literal>&lt;net-match&gt;</literal> entries are scanned in the order declared to see if one of the node&apos;s IP addresses matches one of the <literal>&lt;ip-range&gt;</literal> expressions. If there is a match, <literal>&lt;net-spec&gt;</literal> specifies the network to instantiate. Note that it is the first match for a particular network that counts. This can be used to simplify the match expression for the general case by placing it after the special cases. For example:</para>
        <screen>ip2nets=&quot;tcp(eth1,eth2) 134.32.1.[4-10/2]; tcp(eth1) *.*.*.*&quot;</screen>
        <para>4 nodes on the 134.32.1.* network have 2 interfaces (134.32.1.{4,6,8,10}) but all the rest have 1.</para>
        <screen>ip2nets=&quot;<emphasis role="bold">vib</emphasis> 192.168.0.*; tcp(eth2) 192.168.0.[1,7,4,12]&quot; </screen>
        <para>This describes an IB cluster on 192.168.0.*. Four of these nodes also have IP interfaces; these four could be used as routers.</para>
        <para>Note that match-all expressions (For instance, <literal>*.*.*.*</literal>) effectively mask all other</para>
        <para> <literal>&lt;net-match&gt;</literal> entries specified after them. They should be used with caution.</para>
        <para>Here is a more complicated situation, the route parameter is explained below. We have:</para>
        <itemizedlist>
          <listitem>
            <para>Two TCP subnets</para>
          </listitem>
          <listitem>
            <para>One Elan subnet</para>
          </listitem>
          <listitem>
            <para>One machine set up as a router, with both TCP and Elan interfaces</para>
          </listitem>
          <listitem>
            <para>IP over Elan configured, but only IP will be used to label the nodes.</para>
          </listitem>
        </itemizedlist>
        <screen>options lnet ip2nets=â€tcp 198.129.135.* 192.128.88.98; \
        elan 198.128.88.98 198.129.135.3; \ 
        routes=&apos;cp 1022@elan # Elan NID of router; \
        elan  198.128.88.98@tcp # TCP NID of router  &apos;</screen>
      </section>
      <section remap="h4">
          <title><indexterm><primary>configuring</primary><secondary>network</secondary><tertiary>tcp</tertiary></indexterm>
networks (&quot;tcp&quot;)</title>
        <para>This is an alternative to &quot;<literal>ip2nets</literal>&quot; which can be used to specify the networks to be instantiated explicitly. The syntax is a simple comma separated list of <literal>&lt;net-spec&gt;</literal>s (see above). The default is only used if neither &apos;ip2nets&apos; nor &apos;networks&apos; is specified.</para>
      </section>
      <section remap="h4">
          <title><indexterm><primary>configuring</primary><secondary>network</secondary><tertiary>routes</tertiary></indexterm>
routes (&quot;&quot;)</title>
        <para>This is a string that lists networks and the NIDs of routers that forward to them.</para>
        <para>It has the following syntax (<literal>&lt;w&gt;</literal> is one or more whitespace characters):</para>
        <screen>&lt;routes&gt; :== &lt;route&gt;{ ; &lt;route&gt; }
&lt;route&gt; :== [&lt;net&gt;[&lt;w&gt;&lt;hopcount&gt;]&lt;w&gt;&lt;nid&gt;[:&lt;priority&gt;]{&lt;w&gt;&lt;nid&gt;[:&lt;priority&gt;]}</screen>
        <para>Note: the priority parameter was added in release 2.5.</para>
        <para>So a node on the network <literal>tcp1</literal> that needs to go through a router to get to the Elan network:</para>
        <screen>options lnet networks=tcp1 routes=&quot;elan 1 192.168.2.2@tcpA&quot;</screen>
        <para>The hopcount and priority numbers are used to help choose the best path between multiply-routed configurations.</para>
        <para>A simple but powerful expansion syntax is provided, both for target networks and router NIDs as follows.</para>
        <screen>&lt;expansion&gt; :== &quot;[&quot; &lt;entry&gt; { &quot;,&quot; &lt;entry&gt; } &quot;]&quot;
&lt;entry&gt; :== &lt;numeric range&gt; | &lt;non-numeric item&gt;
&lt;numeric range&gt; :== &lt;number&gt; [ &quot;-&quot; &lt;number&gt; [ &quot;/&quot; &lt;number&gt; ] ]</screen>
        <para>The expansion is a list enclosed in square brackets. Numeric items in the list may be a single number, a contiguous range of numbers, or a strided range of numbers. For example, <literal>routes=&quot;elan 192.168.1.[22-24]@tcp&quot;</literal> says that network <literal>elan0</literal> is adjacent (hopcount defaults to 1); and is accessible via 3 routers on the <literal>tcp0</literal> network (<literal>192.168.1.22@tcp</literal>, <literal>192.168.1.23@tcp</literal> and <literal>192.168.1.24@tcp</literal>).</para>
        <para><literal>routes=&quot;[tcp,vib] 2 [8-14/2]@elan&quot;</literal> says that 2 networks (<literal>tcp0</literal> and <literal>vib0</literal>) are accessible through 4 routers (<literal>8@elan</literal>, <literal>10@elan</literal>, <literal>12@elan</literal> and <literal>14@elan</literal>). The hopcount of 2 means that traffic to both these networks will be traversed 2 routers - first one of the routers specified in this entry, then one more.</para>
        <para>Duplicate entries, entries that route to a local network, and entries that specify routers on a non-local network are ignored.</para>
        <para>Prior to release 2.5, a conflict between equivalent entries was resolved in favor of the route with the shorter hopcount. The hopcount, if omitted, defaults to 1 (the remote network is adjacent)..</para>
        <para condition='l25'>Since 2.5, equivalent entries are resolved in favor of the route with the lowest priority number or shorter hopcount if the priorities are equal. The priority, if omitted, defaults to 0.  The hopcount, if omitted, defaults to 1 (the remote network is adjacent).</para>
        <para>It is an error to specify routes to the same destination with routers on different local networks.</para>
        <para>If the target network string contains no expansions, then the hopcount defaults to 1 and may be omitted (that is, the remote network is adjacent). In practice, this is true for most multi-network configurations. It is an error to specify an inconsistent hop count for a given target network. This is why an explicit hopcount is required if the target network string specifies more than one network.</para>
      </section>
      <section remap="h4">
          <title><indexterm><primary>configuring</primary><secondary>network</secondary><tertiary>forwarding</tertiary></indexterm>
forwarding (&quot;&quot;)</title>
        <para>This is a string that can be set either to &quot;<literal>enabled</literal>&quot; or &quot;<literal>disabled</literal>&quot; for explicit control of whether this node should act as a router, forwarding communications between all local networks.</para>
        <para>A standalone router can be started by simply starting LNET (&apos;<literal>modprobe ptlrpc</literal>&apos;) with appropriate network topology options.</para>
        <informaltable frame="all">
          <tgroup cols="2">
            <colspec colname="c1" colwidth="50*"/>
            <colspec colname="c2" colwidth="50*"/>
            <thead>
              <row>
                <entry>
                  <para><emphasis role="bold">Variable</emphasis></para>
                </entry>
                <entry>
                  <para><emphasis role="bold">Description</emphasis></para>
                </entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>
                  <para> <literal>acceptor</literal></para>
                </entry>
                <entry>
                  <para>The acceptor is a TCP/IP service that some LNDs use to establish communications. If a local network requires it and it has not been disabled, the acceptor listens on a single port for connection requests that it redirects to the appropriate local network. The acceptor is part of the LNET module and configured by the following options:</para>
                  <itemizedlist>
                    <listitem>
                      <para><literal>secure</literal>  - Accept connections only from reserved TCP ports (below 1023).</para>
                    </listitem>
                    <listitem>
                      <para><literal>all</literal>  - Accept connections from any TCP port. </para>
                      <note>
                        <para>This is required for liblustre clients to allow connections on non-privileged ports.</para>
                      </note>
                    </listitem>
                    <listitem>
                      <para><literal>none</literal>  - Do not run the acceptor.</para>
                    </listitem>
                  </itemizedlist>
                </entry>
              </row>
              <row>
                <entry>
                  <para> <literal>accept_port</literal></para>
                  <para> <literal>(988)</literal></para>
                </entry>
                <entry>
                  <para>  Port number on which the acceptor should listen for connection requests. All nodes in a site configuration that require an acceptor must use the same port.</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para> <literal>accept_backlog</literal></para>
                  <para> <literal>(127)</literal></para>
                </entry>
                <entry>
                  <para>Maximum length that the queue of pending connections may grow to (see listen(2)).</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para> <literal>accept_timeout</literal></para>
                  <para> <literal>(5, W)</literal></para>
                </entry>
                <entry>
                  <para>Maximum time in seconds the acceptor is allowed to block while communicating with a peer.</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para> <literal>accept_proto_version</literal></para>
                </entry>
                <entry>
                  <para>Version of the acceptor protocol that should be used by outgoing connection requests. It defaults to the most recent acceptor protocol version, but it may be set to the previous version to allow the node to initiate connections with nodes that only understand that version of the acceptor protocol. The acceptor can, with some restrictions, handle either version (that is, it can accept connections from both &apos;old&apos; and &apos;new&apos; peers). For the current version of the acceptor protocol (version 1), the acceptor is compatible with old peers if it is only required by a single local network.</para>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </informaltable>
      </section>
      <section>
          <title><indexterm><primary>configuring</primary><secondary>network</secondary><tertiary>rnet_htable_size</tertiary></indexterm>
<literal>rnet_htable_size</literal></title>
        <para condition='l23'><literal>rnet_htable_size</literal> is an integer that indicates how many remote networks the internal LNet hash table is configured to handle. <literal>rnet_htable_size</literal> is used for optimizing the hash table size and does not put a limit on how many remote networks you can have.  The default hash table size when this parameter is not specified is: 128.</para>
      </section>
    </section>
    <section remap="h3" xml:id="section_ngq_qhy_zl">
      <title><indexterm>
          <primary>configuring</primary>
          <secondary>network</secondary>
          <tertiary>SOCKLND</tertiary>
        </indexterm>
        <literal>SOCKLND</literal> Kernel TCP/IP LND</title>
      <para>The <literal>SOCKLND</literal> kernel TCP/IP LND (<literal>socklnd</literal>) is
        connection-based and uses the acceptor to establish communications via sockets with its
        peers.</para>
      <para>It supports multiple instances and load balances dynamically over multiple interfaces.
        If no interfaces are specified by the <literal>ip2nets</literal> or networks module
        parameter, all non-loopback IP interfaces are used. The address-within-network is determined
        by the address of the first IP interface an instance of the <literal>socklnd</literal>
        encounters.</para>
      <para>Consider a node on the &apos;edge&apos; of an InfiniBand network, with a low-bandwidth
        management Ethernet (<literal>eth0</literal>), IP over IB configured
          (<literal>ipoib0</literal>), and a pair of GigE NICs
          (<literal>eth1</literal>,<literal>eth2</literal>) providing off-cluster connectivity. This
        node should be configured with &apos;<literal>networks=vib,tcp(eth1,eth2)</literal>&apos; to
        ensure that the <literal>socklnd</literal> ignores the management Ethernet and IPoIB.</para>
      <informaltable frame="all">
        <tgroup cols="2">
          <colspec colname="c1" colwidth="50*"/>
          <colspec colname="c2" colwidth="50*"/>
          <thead>
            <row>
              <entry>
                <para><emphasis role="bold">Variable</emphasis></para>
              </entry>
              <entry>
                <para><emphasis role="bold">Description</emphasis></para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para>
                  <literal>timeout</literal></para>
                <para>
                  <literal>(50,W)</literal></para>
              </entry>
              <entry>
                <para>Time (in seconds) that communications may be stalled before the LND completes
                  them with failure.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>nconnds</literal></para>
                <para>
                  <literal>(4)</literal></para>
              </entry>
              <entry>
                <para>Sets the number of connection daemons.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>min_reconnectms</literal></para>
                <para>
                  <literal>(1000,W)</literal></para>
              </entry>
              <entry>
                <para>Minimum connection retry interval (in milliseconds). After a failed connection
                  attempt, this is the time that must elapse before the first retry. As connections
                  attempts fail, this time is doubled on each successive retry up to a maximum of
                    &apos;<literal>max_reconnectms</literal>&apos;.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>max_reconnectms</literal></para>
                <para>
                  <literal>(6000,W)</literal></para>
              </entry>
              <entry>
                <para>Maximum connection retry interval (in milliseconds).</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>eager_ack</literal></para>
                <para>
                  <literal>(0 on linux,</literal></para>
                <para>
                  <literal>1 on darwin,W)</literal></para>
              </entry>
              <entry>
                <para>Boolean that determines whether the <literal>socklnd</literal> should attempt
                  to flush sends on message boundaries.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>typed_conns</literal></para>
                <para>
                  <literal>(1,Wc)</literal></para>
              </entry>
              <entry>
                <para>Boolean that determines whether the <literal>socklnd</literal> should use
                  different sockets for different types of messages. When clear, all communication
                  with a particular peer takes place on the same socket. Otherwise, separate sockets
                  are used for bulk sends, bulk receives and everything else.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>min_bulk</literal></para>
                <para>
                  <literal>(1024,W)</literal></para>
              </entry>
              <entry>
                <para>Determines when a message is considered &quot;bulk&quot;.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>tx_buffer_size, rx_buffer_size</literal></para>
                <para>
                  <literal>(8388608,Wc)</literal></para>
              </entry>
              <entry>
                <para>Socket buffer sizes. Setting this option to zero (0), allows the system to
                  auto-tune buffer sizes. </para>
                <warning>
                  <para>Be very careful changing this value as improper sizing can harm
                    performance.</para>
                </warning>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>nagle</literal></para>
                <para>
                  <literal>(0,Wc)</literal></para>
              </entry>
              <entry>
                <para>Boolean that determines if <literal>nagle</literal> should be enabled. It
                  should never be set in production systems.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>keepalive_idle</literal></para>
                <para>
                  <literal>(30,Wc)</literal></para>
              </entry>
              <entry>
                <para>Time (in seconds) that a socket can remain idle before a keepalive probe is
                  sent. Setting this value to zero (0) disables keepalives.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>keepalive_intvl</literal></para>
                <para>
                  <literal>(2,Wc)</literal></para>
              </entry>
              <entry>
                <para>Time (in seconds) to repeat unanswered keepalive probes. Setting this value to
                  zero (0) disables keepalives.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>keepalive_count</literal></para>
                <para>
                  <literal>(10,Wc)</literal></para>
              </entry>
              <entry>
                <para>Number of unanswered keepalive probes before pronouncing socket (hence peer)
                  death.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>enable_irq_affinity</literal></para>
                <para>
                  <literal>(0,Wc)</literal></para>
              </entry>
              <entry>
                <para>Boolean that determines whether to enable IRQ affinity. The default is zero
                  (0).</para>
                <para>When set, <literal>socklnd</literal> attempts to maximize performance by
                  handling device interrupts and data movement for particular (hardware) interfaces
                  on particular CPUs. This option is not available on all platforms. This option
                  requires an SMP system to exist and produces best performance with multiple NICs.
                  Systems with multiple CPUs and a single NIC may see increase in the performance
                  with this parameter disabled.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para>
                  <literal>zc_min_frag</literal></para>
                <para>
                  <literal>(2048,W)</literal></para>
              </entry>
              <entry>
                <para>Determines the minimum message fragment that should be considered for
                  zero-copy sends. Increasing it above the platform&apos;s <literal>PAGE_SIZE
                  </literal>disables all zero copy sends. This option is not available on all
                  platforms.</para>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
    </section>
    <section remap="h3">
      <title><indexterm>
          <primary>configuring</primary>
          <secondary>portals</secondary>
        </indexterm>Portals LND Linux (ptllnd)</title>
      <para>The Portals LND Linux (<literal>ptllnd</literal>) can be used as a interface layer to communicate with Sandia Portals networking devices. This version is intended to work on Cray XT3 Linux nodes that use Cray Portals as a network transport.</para>
      <para><emphasis role="bold">Message Buffers</emphasis></para>
      <para>When <literal>ptllnd</literal> starts up, it allocates and posts sufficient message buffers to allow all expected peers (set by concurrent_peers) to send one unsolicited message. The first message that a peer actually sends is (so-called) &quot;<literal>HELLO</literal>&quot; message, used to negotiate how much additional buffering to setup (typically 8 messages). If 10000 peers actually exist, then enough buffers are posted for 80000 messages.</para>
      <para>The maximum message size is set by the <literal>max_msg_size</literal> module parameter (default value is 512). This parameter sets the bulk transfer breakpoint. Below this breakpoint, payload data is sent in the message itself. Above this breakpoint, a buffer descriptor is sent and the receiver gets the actual payload.</para>
      <para>The buffer size is set by the <literal>rxb_npages</literal> module parameter (default value is <literal>1</literal>). The default conservatively avoids allocation problems due to kernel memory fragmentation. However, increasing this value to 2 is probably not risky.</para>
      <para>The <literal>ptllnd</literal> also keeps an additional <literal>rxb_nspare</literal> buffers (default value is 8) posted to account for full buffers being handled.</para>
      <para>Assuming a 4K page size with 10000 peers, 1258 buffers can be expected to be posted at startup, increasing to a maximum of 10008 as peers that are actually connected. By doubling <literal>rxb_npages</literal> halving <literal>max_msg_size</literal>, this number can be reduced by a factor of 4.</para>
      <para><emphasis role="bold">ME/MD Queue Length</emphasis></para>
      <para>The <literal>ptllnd</literal> uses a single portal set by the portal module parameter (default value of 9) for both message and bulk buffers. Message buffers are always attached with <literal>PTL_INS_AFTER</literal> and match anything sent with &quot;message&quot; matchbits. Bulk buffers are always attached with <literal>PTL_INS_BEFORE</literal> and match only specific matchbits for that particular bulk transfer.</para>
      <para>This scheme assumes that the majority of ME/MDs posted are for &quot;message&quot; buffers, and that the overhead of searching through the preceding &quot;bulk&quot; buffers is acceptable. Since the number of &quot;bulk&quot; buffers posted at any time is also dependent on the bulk transfer breakpoint set by <literal>max_msg_size</literal>, this seems like an issue worth measuring at scale.</para>
      <para><emphasis role="bold">TX Descriptors</emphasis></para>
      <para>The <literal>ptllnd</literal> has a pool of so-called &quot;tx descriptors&quot;, which it uses not only for outgoing messages, but also to hold state for bulk transfers requested by incoming messages. This pool should scale with the total number of peers.</para>
      <para>To enable the building of the Portals LND (<literal>ptllnd.ko</literal>) configure with this option:</para>
      <screen>./configure --with-portals=<replaceable>/path/to/portals/headers</replaceable></screen>
      <informaltable frame="all">
        <tgroup cols="2">
          <colspec colname="c1" colwidth="50*"/>
          <colspec colname="c2" colwidth="50*"/>
          <thead>
            <row>
              <entry>
                <para><emphasis role="bold">Variable</emphasis></para>
              </entry>
              <entry>
                <para><emphasis role="bold">Description</emphasis></para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para> <literal>ntx</literal></para>
                <para> <literal>(256)</literal></para>
              </entry>
              <entry>
                <para>Total number of messaging descriptors.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>concurrent_peers</literal></para>
                <para> <literal>(1152)</literal></para>
              </entry>
              <entry>
                <para>Maximum number of concurrent peers. Peers that attempt to connect beyond the maximum are not allowed.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>peer_hash_table_size</literal></para>
                <para> <literal>(101)</literal></para>
              </entry>
              <entry>
                <para>Number of hash table slots for the peers. This number should scale with <literal>concurrent_peers</literal>. The size of the peer hash table is set by the module parameter <literal>peer_hash_table_size</literal> which defaults to a value of 101. This number should be prime to ensure the peer hash table is populated evenly. It is advisable to increase this value to 1001 for ~10000 peers.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>cksum</literal></para>
                <para> <literal>(0)</literal></para>
              </entry>
              <entry>
                <para>Set to non-zero to enable message (not RDMA) checksums for outgoing packets. Incoming packets are always check-summed if necessary, independent of this value.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>timeout</literal></para>
                <para> <literal>(50)</literal></para>
              </entry>
              <entry>
                <para>Amount of time (in seconds) that a request can linger in a peers-active queue before the peer is considered dead.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>portal</literal></para>
                <para> <literal>(9)</literal></para>
              </entry>
              <entry>
                <para>Portal ID to use for the <literal>ptllnd</literal> traffic.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>rxb_npages</literal></para>
                <para> <literal>(64 * #cpus)</literal></para>
              </entry>
              <entry>
                <para>Number of pages in an RX buffer.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>credits</literal></para>
                <para> <literal>(128)</literal></para>
              </entry>
              <entry>
                <para>Maximum total number of concurrent sends that are outstanding to a single peer at a given time.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>peercredits</literal></para>
                <para> <literal>(8)</literal></para>
              </entry>
              <entry>
                <para>Maximum number of concurrent sends that are outstanding to a single peer at a given time.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>max_msg_size</literal></para>
                <para> <literal>(512)</literal></para>
              </entry>
              <entry>
                <para>Maximum immediate message size. This MUST be the same on all nodes in a cluster. A peer that connects with a different <literal>max_msg_size</literal> value will be rejected.</para>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
    </section>
    <section remap="h3">
      <title><indexterm><primary>configuring</primary><secondary>MX LND</secondary></indexterm>MX LND</title>
      <para><literal>MXLND</literal> supports a number of load-time parameters using Linux&apos;s module parameter system. The following variables are available:</para>
      <informaltable frame="all">
        <tgroup cols="2">
          <colspec colname="c1" colwidth="50*"/>
          <colspec colname="c2" colwidth="50*"/>
          <thead>
            <row>
              <entry>
                <para><emphasis role="bold">Variable</emphasis></para>
              </entry>
              <entry>
                <para><emphasis role="bold">Description</emphasis></para>
              </entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>
                <para> <literal>n_waitd</literal></para>
              </entry>
              <entry>
                <para>Number of completion daemons.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>max_peers</literal></para>
              </entry>
              <entry>
                <para>Maximum number of peers that may connect.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>cksum</literal></para>
              </entry>
              <entry>
                <para>Enables small message (below 4 KB) checksums if set to a non-zero value.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>ntx</literal></para>
              </entry>
              <entry>
                <para>Number of total tx message descriptors.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>credits</literal></para>
              </entry>
              <entry>
                <para>Number of concurrent sends to a single peer.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>board</literal></para>
              </entry>
              <entry>
                <para>Index value of the Myrinet board (NIC).</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>ep_id</literal></para>
              </entry>
              <entry>
                <para>MX endpoint ID.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>polling</literal></para>
              </entry>
              <entry>
                <para>Use zero (0) to block (wait). A value greater than 0 will poll that many times before blocking.</para>
              </entry>
            </row>
            <row>
              <entry>
                <para> <literal>hosts</literal></para>
              </entry>
              <entry>
                <para>IP-to-hostname resolution file.</para>
              </entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
      <para>Of the described variables, only hosts is required. It must be the absolute path to the MXLND hosts file.</para>
      <para>For example:</para>
      <screen>options kmxlnd hosts=/etc/hosts.mxlnd</screen>
      <para>The file format for the hosts file is:</para>
      <screen>IP  HOST  BOARD   EP_ID</screen>
      <para>The values must be space and/or tab separated where:</para>
      <para><literal>IP</literal> is a valid IPv4 address</para>
      <para><literal>HOST</literal> is the name returned by <literal>`hostname`</literal> on that machine</para>
      <para><literal>BOARD</literal> is the index of the Myricom NIC (0 for the first card, etc.)</para>
      <para><literal>EP_ID</literal> is the MX endpoint ID</para>
      <para>To obtain the optimal performance for your platform, you may want to vary the remaining options.</para>
      <para><literal>n_waitd(1)</literal> sets the number of threads that process completed MX requests (sends and receives).</para>
      <para><literal>max_peers(1024)</literal> tells MXLND the upper limit of machines that it will need to communicate with. This affects how many receives it will pre-post and each receive will use one page of memory. Ideally, on clients, this value will be equal to the total number of Lustre servers (MDS and OSS). On servers, it needs to equal the total number of machines in the storage system. cksum (0) turns on small message checksums. It can be used to aid in troubleshooting. MX also provides an optional checksumming feature which can check all messages (large and small). For details, see the MX README.</para>
      <para><literal>ntx(256)</literal> is the number of total sends in flight from this machine. In actuality, MXLND reserves half of them for connect messages so make this value twice as large as you want for the total number of sends in flight.</para>
      <para><literal>credits(8)</literal> is the number of in-flight messages for a specific peer.
        This is part of the flow-control system in provided by the Lustre software. Increasing this
        value may improve performance but it requires more memory because each message requires at
        least one page.</para>
      <para><literal>board(0)</literal> is the index of the Myricom NIC. Hosts can have multiple Myricom NICs and this identifies which one MXLND should use. This value must match the board value in your MXLND hosts file for this host.</para>
      <para><literal>ep_id(3)</literal> is the MX endpoint ID. Each process that uses MX is required to have at least one MX endpoint to access the MX library and NIC. The ID is a simple index starting at zero (0). This value must match the endpoint ID value in your MXLND hosts file for this host.</para>
      <para><literal>polling(0)</literal> determines whether this host will poll or block for MX request completions. A value of 0 blocks and any positive value will poll that many times before blocking. Since polling increases CPU usage, we suggest that you set this to zero (0) on the client and experiment with different values for servers.</para>
    </section>
  </section>
</chapter>
