<?xml version='1.0' encoding='UTF-8'?><chapter xmlns="http://docbook.org/ns/docbook" xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en-US" xml:id="installinglustrefromsourcecode">
  <title xml:id="installinglustrefromsourcecode.title">Installing a Lustre* File System from Source
    Code</title>
  <para>This chapter describes how to create a customized Lustre* server kernel from source code.
    Sections included are:</para>
  <itemizedlist>
    <listitem>
      <para><xref linkend="dbdoclet.50438210_69313"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438210_65411"/></para>
    </listitem>
    <listitem>
      <para><xref linkend="dbdoclet.50438210_47529"/></para>
    </listitem>
    <listitem>
      <para><xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="section_g4d_yby_lk"/></para>
    </listitem>
  </itemizedlist>
  <note>
    <para>It is recommended that you install from prebuild RPMs of the Lustre software unless you
      need to customize the Lustre server kernel or will be using an Linux kernel that has not been
      tested with the Lustre software. </para>
    <para>For a list of supported Linux distributions and architectures, see <xref
        xmlns:xlink="http://www.w3.org/1999/xlink" linkend="LustreTestMatrixTable"/>. Prebuild RPMs
      are available in the <link xmlns:xlink="http://www.w3.org/1999/xlink"
        xlink:href="https://wiki.hpdd.intel.com/display/PUB/Lustre+Releases">Lustre Releases</link>
      repository. For information about installing Lustre RPMs, see <xref
        xmlns:xlink="http://www.w3.org/1999/xlink" linkend="installinglustre"/>.</para>
  </note>
  <section xml:id="dbdoclet.50438210_69313">
      <title>
          <indexterm><primary>installing</primary><secondary>from source</secondary></indexterm>
          Overview and Prerequisites</title>
    <para>To install Lustre from source code, the following are required:</para>
    <itemizedlist>
      <listitem>
        <para>An x86_64 machine with a fresh installation of a CentOS (or Red Hat*) 6 Linux
          operating system.</para>
      </listitem>
      <listitem>
        <para>Access to the <link xmlns:xlink="http://www.w3.org/1999/xlink"
            xlink:href="https://wiki.hpdd.intel.com/display/PUB/Lustre+Releases">Lustre
            Releases</link> repository. This repository contains Lustre software patches and a test
          suite.</para>
      </listitem>
      <listitem>
        <para>Access to a recent version of <link xmlns:xlink="http://www.w3.org/1999/xlink"
            xlink:href="http://fedoraproject.org/wiki/EPEL">EPEL</link> containing the
            <code>quilt</code> utility used for managing a series of patches. </para>
      </listitem>
      <listitem>
        <para><emphasis role="italic">(Recommended)</emphasis> At least 1 GB memory on the machine
          used for the build.</para>
      </listitem>
      <listitem>
        <para><emphasis role="italic">(Recommended)</emphasis> At least 20 GB hard disk space on the
          machine used for the build. </para>
      </listitem>
      <listitem>
        <para>Security-Enhanced Linux (SELinux) <emphasis role="italic">disabled</emphasis> on all
          Lustre servers and clients.  The Lustre software does not support SELinux.</para>
      </listitem>
    </itemizedlist>
    <para>The installation procedure includes several steps:</para>
    <itemizedlist>
      <listitem>
        <para> Patching the core kernel.</para>
      </listitem>
      <listitem>
        <para> Building Lustre RPMs.</para>
      </listitem>
      <listitem>
        <para> Installing and testing the Lustre file system.</para>
      </listitem>
    </itemizedlist>
    <para>These steps are described in the following sections.</para>
  </section>
  <section xml:id="dbdoclet.50438210_65411">
    <title><indexterm><primary>installing</primary><secondary>from source</secondary><tertiary>patching the kernel</tertiary></indexterm>Patching the Kernel</title>
    <para>This section first describes how to prepare your machine to serve as a development
      environment, including build tools, the Lustre source, and the Linux kernel source. It then
      describes how to apply Lustre patches to the Linux kernel.</para>
    <note>
      <para>A patched Linux kernel is not required on Lustre clients.</para>
    </note>
    <section remap="h3">
      <title><indexterm>
          <primary>quilt</primary>
        </indexterm>Provisioning the Build Machine and Installing Dependencies</title>
      <note>
        <para>This example procedure assumes a Red Hat* Enteprise Linux* 6 operating system has been
          freshly installed on a machine with the hostname <literal>rhel6-master</literal>.</para>
      </note>
      <para>To provision the build machine and install dependencies, complete these steps.</para>
      <orderedlist>
        <listitem>
          <para>Log in as <systemitem>root</systemitem>.</para>
        </listitem>
        <listitem>
          <para>Install the kernel development tools:</para>
          <para>
            <screen># yum -y groupinstall "Development Tools"</screen>
          </para>
          <note>
            <para>If the Development Tools group is not available, you may need to install the
              packages individually using:</para>
            <para>
              <screen># yum -y install automake xmlto asciidoc 
   elfutils-libelf-devel zlib-devel binutils-devel 
   newt-devel python-devel hmaccalc perl-ExtUtils-Embed 
   rpm-build make gcc redhat-rpm-config patchutils git</screen>
            </para>
          </note>
        </listitem>
        <listitem>
          <para>Install additional dependencies:</para>
          <para>
            <screen># yum -y install xmlto asciidoc  elfutils-libelf-devel 
     zlib-devel binutils-devel newt-devel python-devel  hmaccalc 
     perl-ExtUtils-Embed</screen>
          </para>
        </listitem>
        <listitem>
          <para>Install EPEL:</para>
          <para>
            <screen># wget 
     http://download.fedoraproject.org/pub/epel/5/x86_64/
     epel-release-5-4.noarch.rpm
# rpm -ivh ./epel-release-5-4.noarch.rpm
</screen>
          </para>
        </listitem>
        <listitem>
          <para>Install quilt:</para>
          <para>
            <screen># yum -y install quilt
</screen>
          </para>
          <note>
            <para>
              <package>newt-devel</package> may not be available for RHEL6. One option is to
              download the <link xmlns:xlink="http://www.w3.org/1999/xlink"
                xlink:href="http://mirror.centos.org/centos/6/os/x86_64/Packages/newt-devel-0.52.11-3.el6.x86_64.rpm"
                >newt-devel</link>, <link xmlns:xlink="http://www.w3.org/1999/xlink"
                xlink:href="http://mirror.centos.org/centos/6/os/x86_64/Packages/slang-devel-2.2.1-1.el6.x86_64.rpm"
                >slang-devel</link>, and <link xmlns:xlink="http://www.w3.org/1999/xlink"
                xlink:href="http://mirror.centos.org/centos/6/os/i386/Packages/asciidoc-8.4.5-4.1.el6.noarch.rpm"
                >asciidoc</link> RPMs from CentOS and install using:</para>
            <para>
              <screen>yum --nogpgcheck localinstall
   ./newt-devel-0.52.11-3.el6.x86_64.rpm
   ./slang-devel-2.2.1-1.el6.x86_64.rpm
   ./asciidoc-8.4.5-4.1.el6.noarch.rpm
</screen>
            </para>
          </note>
        </listitem>
      </orderedlist>
    </section>
    <section remap="h3">
      <title>Preparing the Lustre Source</title>
      <para>To prepare the Lustre source, complete these steps.</para>
      <orderedlist>
        <listitem>
          <para>Create a user called <systemitem>build</systemitem> with a home directory
              <systemitem>/home/build</systemitem>:</para>
          <para>
            <screen># useradd -m build
</screen>
          </para>
        </listitem>
        <listitem>
          <para>Switch to the user called <systemitem>build</systemitem> and change the directory to
            the <systemitem>$HOME/build</systemitem> directory:</para>
          <para>
            <screen># su build
# cd $HOME
</screen>
          </para>
        </listitem>
        <listitem>
          <para>Get the MASTER branch of the Lustre software from the Lustre repository:</para>
          <para>
            <screen># git clone git://git.whamcloud.com/fs/lustre-release.git
# cd lustre-release
</screen>
          </para>
        </listitem>
        <listitem>
          <para>Run:</para>
          <para>
            <screen>sh ./autogen.sh
</screen>
          </para>
        </listitem>
        <listitem>
          <para>Resolve any outstanding dependencies. </para>
          <para><screen># sh ./autogen.sh</screen>When <package>autogen.sh</package> completes
            successfully, a response similar to the following is displayed: </para>
          <para>
            <screen>Checking for a complete tree...
checking forautomake-1.9&gt;= 1.9... found 1.9.6
...
...
configure.ac:10: installing `./config.sub'
configure.ac:12: installing `./install-sh'
configure.ac:12: installing `./missing'
Running autoconf</screen>
          </para>
        </listitem>
      </orderedlist>
    </section>
    <section remap="h3">
      <title>Preparing the Kernel Source</title>
      <para>To build the kernel using <literal>rpmbuild</literal> (a tool specific to RPM-based
        distributions), complete these steps.</para>
      <orderedlist>
        <listitem>
          <para>Get the kernel source: </para>
          <para>
            <screen># cd $HOME
# mkdir -p kernel/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
# cd kernel
# echo '%_topdir %(echo $HOME)/kernel/rpmbuild'&gt; ~/.rpmmacros
</screen>
          </para>
        </listitem>
        <listitem>
          <para>Install the kernel source (enter on one line):</para>
          <para>
            <screen># rpm -ivh http://ftp.redhat.com/pub/redhat/linux/enterprise/
    6Server/en/os/SRPMS/kernel-2.6.32-131.2.1.el6.src.rpm 
    2&gt;&amp;1 | grep -v mockb</screen>
          </para>
          <note>
            <para>It is intended that the Lustre software MASTER branch be kept up-to-date with the
              most recent kernel distributions. However, a delay may occur between a periodic update
              to a kernel distribution and a corresponding update of the MASTER branch. The most
              recent supported kernel in the MASTER branch can be found in the source directory in
                <systemitem>lustre/kernel_patches/which_patch</systemitem>. If the MASTER branch is
              not current with the latest  distribution, download the most recent kernel RPMs from
              the vendor's download site.</para>
          </note>
        </listitem>
        <listitem>
          <para>Prepare the source using <literal>rpmbuild</literal>:</para>
          <para>
            <screen># cd ~/kernel/rpmbuild
# rpmbuild -bp --target=`uname -m` ./SPECS/kernel.spec
</screen>
          </para>
          <para>The text displayed ends with the following:</para>
          <para>
            <screen>...
gpg: Total number processed: 1
gpg:               imported: 1
+ gpg --homedir . --export --keyring ./kernel.pub Red
gpg: WARNING: unsafe permissions on homedir `.'
+ gcc -o scripts/bin2c scripts/bin2c.c
+ scripts/bin2c ksign_def_public_key __initdata
+ cd ..
+ exit 0</screen>
          </para>
        </listitem>
      </orderedlist>
      <para>The kernel source with the Red Hat Enterprise Linux patches applied is now residing in
        the directory
          <systemitem>/home/build/kernel/rpmbuild/BUILD/kernel-2.6.32-131.2.1.el6/linux-2.6.32-131.2.1.el6.x86_64/</systemitem></para>
    </section>
    <section remap="h3">
      <title>Patching the Kernel Source with the Lustre Code</title>
      <para>To patch the kernel source with the Lustre code, complete these steps.</para>
      <orderedlist>
        <listitem>
          <para>Go to the directory containing the kernel source:</para>
          <para>
            <screen>#cd ~/kernel/rpmbuild/BUILD/kernel-2.6.32-131.2.1.el6/
     linux-2.6.32-131.2.1.el6.x86_64/</screen>
          </para>
        </listitem>
        <listitem>
          <para>Edit the <filename>Makefile</filename> file in this directory to add a unique build
            id to be able to ascertain that the kernel is booted. Modify line 4 as shown
            below:</para>
          <para>
            <screen>EXTRAVERSION = .lustremaster</screen>
          </para>
        </listitem>
        <listitem>
          <para>Overwrite the <filename>.config</filename> file in this directory with the Lustre
              <filename>.config</filename> file:</para>
          <para>
            <screen># cp ~/lustre-release/lustre/kernel_patches/kernel_configs/
     kernel-2.6.32-2.6-rhel6-x86_64.config ./.config</screen>
          </para>
        </listitem>
        <listitem>
          <para>Link the Lustre series and patches:</para>
          <para>
            <screen># ln -s ~/lustre-release/lustre/kernel_patches/series/
     2.6-rhel6.series series
# ln -s ~/lustre-release/lustre/kernel_patches/patches patches</screen>
          </para>
        </listitem>
        <listitem>
          <para>Apply the patches to the kernel source using <package>quilt</package>:</para>
          <para>
            <screen># quilt push -av</screen>
          </para>
          <para>The following is displayed:</para>
          <screen>...
...
patching file fs/jbd2/transaction.c
Hunk #3succeeded at 1222(offset 3lines).
Hunk #4succeeded at 1357(offset 3lines).
Now at patch  patches/jbd2-jcberr-2.6-rhel6.patch</screen>
        </listitem>
      </orderedlist>
    </section>
  </section>
  <section xml:id="dbdoclet.50438210_47529">
    <title>
      <indexterm>
        <primary>installing</primary>
        <secondary>from source</secondary>
        <tertiary>packaging</tertiary>
      </indexterm> Building the Lustre RPMs</title>
    <para>This section describes how to configure the patched kernel to work with the Lustre
      software and how to create and install the Lustre packages (RPMs).</para>
    <section>
      <title>Building a New Kernel</title>
      <para>To build a new kernel as an RPM, complete these steps.</para>
      <orderedlist>
        <listitem>
          <para>In the kernel source directory, build a kernel rpm:</para>
          <screen># cd ~/kernel/rpmbuild/BUILD/kernel-2.6.32-131.2.1.el6/
     linux-2.6.32-131.2.1.el6.x86_64/
# make oldconfig || make menuconfig
# make include/asm
# make include/linux/version.h
# make SUBDIRS=scripts
# make include/linux/utsrelease.h
# make rpm</screen>
          <para>A successful build  returns text similar to the following:</para>
          <screen>...
...
Wrote: /home/build/kernel/rpmbuild/SRPMS/
     kernel-2.6.32lustremaster-1.src.rpm
Wrote: /home/build/kernel/rpmbuild/RPMS/x86_64/
     kernel-2.6.32.lustremaster-1.x86_64.rpm
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.f73m1V
+ umask 022+ cd /home/build/kernel/rpmbuild/BUILD
+ cd kernel-2.6.32lustremaster
+ rm -rf /home/build/kernel/rpmbuild/BUILDROOT/
     kernel-2.6.32.lustremaster-1.x86_64
+ exit 0
rm ../kernel-2.6.32lustremaster.tar.gz</screen>
          <note>
            <para>If a request to generate more entropy appears, some disk or keyboard I/O needs to
              be generated. You can generate entropy by entering the following on another
              terminal:<screen># grep -Ri 'any_text' /usr</screen></para>
          </note>
        </listitem>
      </orderedlist>
      <para>A fresh kernel RPM can now be found at
          <systemitem>~/kernel/rpmbuild/RPMS/x86_64/kernel-2.6.32.lustremaster-1.x86_64.rpm</systemitem>.</para>
    </section>
    <section>
      <title>Configuring and Building Lustre RPMs</title>
      <para>To configure and build a set of Lustre RPMs, complete these steps.<orderedlist>
          <listitem>
            <para>Configure the Lustre source:</para>
            <para>
              <screen># cd ~/lustre-release/
# ./configure --with-linux=/home/build/kernel/rpmbuild/BUILD/
     kernel-2.6.32.lustremaster/</screen>
            </para>
            <para>Text similar to the following is displayed:</para>
            <para>
              <screen>...
...
LLCPPFLAGS:    -D__arch_lib__ -D_LARGEFILE64_SOURCE=1
CFLAGS:        -g -O2 -Werror
EXTRA_KCFLAGS:  -include /home/build/lustre-release/config.h  -g 
     -I/home/build/lustre-release
/libcfs/include  -I/home/build/lustre-release/lnet/include 
     -I/home/build/lustre-release/
lustre/include
LLCFLAGS:      -g -Wall -fPIC -D_GNU_SOURCE 
Type 'make' to build Lustre.</screen>
            </para>
          </listitem>
          <listitem>
            <para>Create the RPMs:</para>
            <para>
              <screen># make rpms</screen>
            </para>
            <para>Text similar to the following is displayed:</para>
            <para>
              <screen>...
...
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.TsLWpD
+ umask 022
+ cd /home/build/kernel/rpmbuild/BUILD
+ cd lustre-2.0.61
+ rm -rf /home/build/kernel/rpmbuild/BUILDROOT/
     lustre-2.0.61-2.6.32_lustremaster_g0533e7b.x86_64
+ exit 0
make[1]: Leaving directory `/home/build/lustre-release'</screen>
            </para>
          </listitem>
        </orderedlist></para>
      <para>The resulting RPMs are in
        <systemitem>~build/kernel/rpmbuild/RPMS/x86_64/</systemitem>.<screen>kernel-2.6.32lustremaster-1.x86_64.rpm
lustre-2.0.61-2.6.32.lustremaster_g0533e7b.x86_64.rpm
lustre-debuginfo-2.0.61-2.6.32.lustremaster_g0533e7b.x86_64.rpm
lustre-ldiskfs-3.3.0-2.6.32.lustremaster_g0533e7b.x86_64.rpm
lustre-ldiskfs-debuginfo-3.3.0-2.6.32.lustremaster_g0533e7b.x86_64.rpm
lustre-modules-2.0.61-2.6.32.lustremaster_g0533e7b.x86_64.rpm
lustre-source-2.0.61-2.6.32.lustremaster_g0533e7b.x86_64.rpm
lustre-tests-2.0.61-2.6.32.lustremaster_g0533e7b.x86_64.rpm</screen></para>
    </section>
    <section>
      <title>Installing the Lustre Kernel</title>
      <para>To install the Lustre kernel, complete these steps.<orderedlist>
          <listitem>
            <para>As <systemitem>root</systemitem>, install the kernel:</para>
            <para>
              <screen># rpm -ivh ~build/kernel/rpmbuild/RPMS/x86_64/
     kernel-2.6.32.lustremaster-1.x86_64.rpm</screen>
            </para>
          </listitem>
          <listitem>
            <para>Create <literal>initrd</literal> using <literal>dracut</literal>:</para>
            <para>
              <screen># /sbin/new-kernel-pkg --package kernel --mkinitrd --dracut 
     --depmod --install 2.6.32.lustremaster</screen>
            </para>
          </listitem>
          <listitem>
            <para>(Optional) To mount the Lustre file system at boot, modify
                <literal>/etc/fstab</literal> to add required entries.</para>
            <para condition="l24">In Lustre Release 2.4, the script
                <literal>/etc/init.d/lustre</literal> has been provided to allow the Lustre file
              system to be enabled as a service. To enable the service, enter the command
                <literal>chkconfig lustre on</literal>.</para>
          </listitem>
          <listitem>
            <para>(Optional) Customize the LNET configuration:</para>
            <para>
              <screen># vi /etc/modprobe.d/lustre.conf</screen>
            </para>
            <para condition="l24">In Lustre Release 2.4, the script
                <literal>/etc/init.d/lnet</literal> has been provided to allow LNET to be enabled as
              a service (for example, on a router). To enable this service, enter the command
                <literal>chkconfig lnet on</literal>.</para>
          </listitem>
          <listitem>
            <para>Reboot the system:</para>
            <para>
              <screen>reboot</screen>
            </para>
            <para>A login prompt such as that shown below indicates
              success:<screen>Red Hat Enterprise Linux Server release 6.0(Santiago)
Kernel 2.6.32lustremaster on an x86_64 

client-10login:
</screen></para>
          </listitem>
        </orderedlist></para>
    </section>
  </section>
  <section xml:id="section_g4d_yby_lk">
    <title>Installing and Testing a Lustre File System</title>
    <para>This section describes how to install the Lustre RPMs and run the Lustre test
      suite.</para>
    <section>
      <title>Installing <package>e2fsprogs</package></title>
      <para>The <literal>e2fsprogs</literal> package is required to run the test suite. To download
        and install <literal>e2fsprogs</literal>, complete these steps.<orderedlist>
          <listitem>
            <para>Download <literal>e2fsprogs</literal> from the <link
                xmlns:xlink="http://www.w3.org/1999/xlink"
                xlink:href="https://wiki.hpdd.intel.com/display/PUB/Lustre+Releases">Lustre
                Releases</link> repository.</para>
          </listitem>
          <listitem>
            <para>Install the <literal>e2fsprogs</literal> package:</para>
            <para>
              <screen># rpm -Uvh
     ./e2fsprogs-1.42.6.wc2-7.el6.x86_64.rpm 
     ./e2fsprogs-libs-1.42.6.wc2-7.el6.x86_64.rpm

</screen>
            </para>
          </listitem>
        </orderedlist></para>
    </section>
    <section>
      <title>Installing the Lustre RPMs</title>
      <para>To install the Lustre RPMs, complete these steps as <systemitem>root</systemitem>:<orderedlist>
          <listitem>
            <para>Make the directory containing the Lustre RPMs your current directory:</para>
            <para>
              <screen># cd /home/build/kernel/rpmbuild/RPMS/x86_64/
</screen>
            </para>
          </listitem>
          <listitem>
            <para>Install the RPMs:</para>
            <para>
              <screen># rpm -ivh lustre-ldiskfs-3.3.0-2.6.32.lustremaster*
# rpm -ivh lustre-modules-2.0.61-2.6.32.lustremaster*
# rpm -ivh lustre-2.0.61-2.6.32.lustremaster_*
# rpm -ivh lustre-tests-*</screen>
            </para>
          </listitem>
        </orderedlist></para>
    </section>
    <section>
      <title>Running the Test Suite</title>
      <para>To test a single node Lustre file system installation, complete these steps.<orderedlist>
          <listitem>
            <para>Run the test suite.</para>
            <para>
              <screen># /usr/lib64/lustre/tests/llmount.sh</screen>
            </para>
            <para>Text similar to the following will be
              displayed:<screen>Loading modules from /usr/lib64/lustre/tests/..
debug=0x33f0404
subsystem_debug=0xffb7e3ff
gss/krb5 is not supported
Formatting mgs, mds, osts
Format mds1: /tmp/lustre-mdt1
Format ost1: /tmp/lustre-ost1
Format ost2: /tmp/lustre-ost2
Checking servers environments
Checking clients rhel6-master environments
Loading modules from /usr/lib64/lustre/tests/..
debug=0x33f0404
subsystem_debug=0xffb7e3ff
gss/krb5 is not supported
Setup mgs, mdt, osts
Starting mds1: -o loop,user_xattr,acl  
/tmp/lustre-mdt1 /mnt/mds1
debug=0x33f0404
subsystem_debug=0xffb7e3ff
debug_mb=10
Started lustre-MDT0000
Starting ost1: -o loop /tmp/lustre-ost1 /mnt/ost1
debug=0x33f0404
subsystem_debug=0xffb7e3ff
debug_mb=10
Started lustre-OST0000
Starting ost2: -o loop /tmp/lustre-ost2 /mnt/ost2
debug=0x33f0404
subsystem_debug=0xffb7e3ff
debug_mb=10
Started lustre-OST0001
Starting client: rhel5-build: -o user_xattr,acl,flock 
rhel6-master@tcp:/lustre /mnt/lustre
debug=0x33f0404
subsystem_debug=0xffb7e3ff
debug_mb=10
Using TIMEOUT=20
disable quota as required</screen></para>
            <para>The Lustre file system is now available at
              <systemitem>/mnt/lustre</systemitem>.</para>
            <note>
              <para>If you see the error below, associate the IP address of a non-loopback interface
                with the name of your machine in the file
                <filename>/etc/hosts</filename>.<screen>mkfs.lustre: Can't parse NID 'rhel6-master@tcp'</screen></para>
            </note>
          </listitem>
        </orderedlist></para>
    </section>
  </section>
</chapter>
